<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>馃挍 讞讬-讗诪转 VOICE | Hai-Emet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/8.5.0/docx.min.js    "></script>
    <script src="/static/live-stream-transcriber.js"></script>
    <style>
        /* =========================================
           SITE LANGUAGE SELECTOR
           ========================================= */
        #siteLanguageSelector {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.9);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 30;
            border: 1px solid rgba(255,215,0,0.5);
            backdrop-filter: blur(10px);
        }
        
        #siteLanguageSelector select {
            background: rgba(255,255,255,0.1);
            color: #ffd700;
            border: 1px solid rgba(255,215,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            direction: rtl;
        }
        
        .app-container {
            display: flex;
            width: 100%;
            height: 100vh;
        }
        
        /* ============ SIDEBAR PANEL LEFT ============ */
        .voice-panel {
            width: 320px;
            background: white;
            border-left: 1px solid #e0e0e0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            transition: width 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 10px rgba(0,0,0,0.05);
        }
        
        .voice-panel.open {
            width: 320px;
        }
        
        .panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            font-weight: bold;
            text-align: center;
            font-size: 1em;
            white-space: nowrap;
        }
        
        .panel-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .section-title {
            font-size: 0.9em;
            font-weight: bold;
            color: #667eea;
            margin: 12px 0 8px 0;
            padding-bottom: 6px;
            border-bottom: 2px solid #667eea;
        }
        
        .transcription-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            margin-bottom: 12px;
            min-height: 80px;
            max-height: 250px;
            overflow-y: auto;
            word-break: break-word;
            white-space: normal;
            line-height: 1.6;
        }
        
        .transcription-label {
            font-size: 0.75em;
            color: #999;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
        }
        
        #finalTranscript {
            font-size: 1.05em;
            font-weight: 600;
            color: #000;
            line-height: 2.2;
            word-break: break-word;
            white-space: pre-wrap;
            direction: rtl;
            text-align: right;
            unicode-bidi: plaintext;
            min-height: 40px;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #finalTranscript:empty::before {
            content: "馃帳 讛转诪诇讜诇 讬讜驻讬注 讻讗谉...";
            color: #999;
            font-weight: normal;
            font-size: 0.9em;
        }
        
        #translatedText {
            font-size: 0.95em;
            color: #667eea;
            font-weight: 500;
            line-height: 2;
            word-break: break-word;
            white-space: pre-wrap;
            direction: rtl;
            text-align: right;
            unicode-bidi: plaintext;
        }
        
        .status-indicator {
            background: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            text-align: center;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .control-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .control-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .control-btn.recording {
            background: #ff6b6b;
            color: white;
            border-color: #ff6b6b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .lang-select {
            padding: 10px 12px;
            border-radius: 8px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.9em;
            width: 100%;
            margin-bottom: 8px;
        }
        
        .file-upload-box {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px dashed #667eea;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 8px;
        }
        
        .file-upload-box:hover {
            background: #e9ecef;
            border-color: #764ba2;
        }
        
        .file-upload-box input {
            display: none;
        }
        
        .files-list {
            margin-top: 8px;
        }
        
        .file-item {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 6px;
            border: 1px solid #e0e0e0;
            font-size: 0.85em;
        }
        
        .file-name {
            font-weight: 600;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .file-transcription {
            background: #f0f7f4;
            border: 1px solid #667eea;
            padding: 6px;
            border-radius: 4px;
            margin-top: 4px;
            font-size: 0.8em;
            color: #2e7d32;
            max-height: 80px;
            overflow-y: auto;
        }
        
        /* ============ MAIN CHAT AREA ============ */
        .main-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 0.9em;
            opacity: 0.95;
        }
        
        .badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            margin-top: 10px;
        }
        
        .toggle-panel-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            z-index: 100;
            transition: all 0.3s;
        }
        
        .toggle-panel-btn:hover {
            transform: scale(1.05);
        }
        
        .chat-area {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .message {
            margin-bottom: 12px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message.assistant {
            justify-content: flex-start;
        }
        
        .message-wrapper {
            display: flex;
            flex-direction: column;
        }
        
        .message.user .message-wrapper {
            align-items: flex-end;
        }
        
        .message.assistant .message-wrapper {
            align-items: flex-start;
        }
        
        .message-content {
            max-width: 80%;
            padding: 12px 15px;
            border-radius: 15px;
            line-height: 1.5;
            font-size: 15px;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
            text-align: right;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            display: inline-block;
            vertical-align: top;
            unicode-bidi: plaintext;
        }
        
        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-left-radius: 0;
            direction: rtl;
            text-align: right;
            line-height: 1.5;
        }
        
        .message.assistant .message-content {
            background: white;
            color: #333;
            border-bottom-right-radius: 0;
            border: 1px solid #e0e0e0;
            direction: rtl;
            text-align: right;
            line-height: 1.5;
        }
        
        .message-time {
            font-size: 0.65em;
            color: #999;
            padding: 5px 10px;
        }
        
        .input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e0e0e0;
        }
        
        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        input[type="text"] {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
            font-size: 1em;
        }
        
        .empty-files {
            text-align: center;
            color: #999;
            font-size: 0.85em;
            padding: 10px;
        }

        #videoContainer {
            margin-top: 8px;
            display: none;
            border-radius: 8px;
            overflow: hidden;
            background: #000;
        }

        #videoPlayerWrapper {
            width: 100%;
            background: #000;
            border-radius: 8px;
            margin-bottom: 8px;
            overflow: hidden;
        }

        #videoPlayer {
            display: none;
            background: #000;
            width: 100%;
            height: auto;
            min-height: 480px;
        }

        #videoTranscript {
            line-height: 2;
            font-size: 1.1em;
            color: #FFFFFF;
            text-shadow: 0 0 4px #000000;
            direction: rtl;
            text-align: center;
            padding: 12px;
            min-height: 60px;
            background: rgba(0,0,0,0.8);
            border-radius: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        textarea {
            direction: rtl;
            text-align: right;
        }

        /* ============ RESPONSIVE ============ */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .voice-panel {
                position: fixed;
                right: 0;
                top: 0;
                width: 0;
                height: 100vh;
                z-index: 999;
                border-left: none;
                border-right: 1px solid #e0e0e0;
                transition: width 0.3s ease;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .voice-panel.open {
                width: 80vw !important;
                box-shadow: -3px 0 15px rgba(0,0,0,0.2);
                max-width: 350px;
            }
            
            .main-container {
                width: 100%;
            }

            .toggle-panel-btn {
                top: 10px;
                right: 10px;
                padding: 10px 12px;
                font-size: 1em;
                z-index: 1000;
            }

            .header h1 {
                font-size: 1.5em;
            }

            .header p {
                font-size: 0.8em;
            }

            .message-content {
                max-width: 85%;
            }
            
            /* Device manager visible on mobile */
            #audioDeviceSelect,
            #videoDeviceSelect {
                width: 100%;
                padding: 10px;
                margin: 8px 0;
                font-size: 14px;
            }
        }

        @media (max-width: 480px) {
            .voice-panel.open {
                width: 100vw !important;
                max-width: 100%;
            }
            
            .header h1 {
                font-size: 1.2em;
            }

            .badge {
                font-size: 0.75em;
            }

            .message-content {
                max-width: 90%;
                font-size: 0.95em;
                padding: 10px 12px;
                line-height: 1.9;
            }

            input[type="text"] {
                font-size: 16px;
            }

            .send-btn {
                padding: 10px 16px;
                font-size: 0.9em;
            }

            .control-btn {
                padding: 8px 10px;
                font-size: 0.85em;
            }

            .lang-select {
                font-size: 0.85em;
                padding: 8px 10px;
            }
        }
    </style>
    
    <style>
        /* =========================================
           QUANTUM VISUALIZATION LAYER
           ========================================= */
        #quantumVisualizer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
            pointer-events: none;
            opacity: 0.3;
        }

        #quantumCore {
            display: none !important;
            /* 讛注讬讙讜诇 讛讜住专 诇讘拽砖转 谞转谞讬讗诇 */
        }
        
        @keyframes quantumBreathe {
            0%, 100% { 
                transform: translate(-50%, -50%) scale(1); 
                filter: hue-rotate(0deg);
                opacity: 0.3;
            }
            50% { 
                transform: translate(-50%, -50%) scale(1.15); 
                filter: hue-rotate(180deg);
                opacity: 0.5;
            }
        }

        #quantumCore.quantum-active {
            animation: quantumPulse 0.5s infinite, quantumBreathe 2s infinite;
            box-shadow: 0 0 300px rgba(255,215,0,0.6), 0 0 500px rgba(255,0,64,0.4);
        }
        
        @keyframes quantumPulse {
            0%, 100% { 
                box-shadow: 0 0 100px rgba(255,215,0,0.3), 0 0 200px rgba(255,0,64,0.3);
                border-color: rgba(0,255,255,0.5);
            }
            50% { 
                box-shadow: 0 0 200px rgba(255,215,0,0.6), 0 0 400px rgba(255,0,64,0.6);
                border-color: rgba(255,0,255,0.8);
            }
        }

        #quantumMetrics {
            position: fixed;
            top: 90px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            padding: 12px;
            border-radius: 8px;
            font-size: 11px;
            z-index: 25;
            border: 1px solid rgba(255,0,255,0.5);
            color: #ff00ff;
            font-family: 'Courier New', monospace;
            min-width: 200px;
            backdrop-filter: blur(10px);
        }

        #quantumLangIndicator {
            position: fixed;
            top: 80px;
            left: 20px;
            transform: none;
            background: rgba(0,0,0,0.85);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 25;
            border: 1px solid rgba(255,215,0,0.5);
            color: #ffd700;
            backdrop-filter: blur(10px);
            display: none;
            max-width: 300px;
        }

        /* 鉁?EXPANDED VIDEO TRANSLATION PANEL */
        .video-translation-panel {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .video-translation-panel h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.3em;
            text-align: center;
        }

        .translation-lang-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .translation-lang-tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9em;
            font-weight: bold;
        }

        .translation-lang-tab:hover, .translation-lang-tab.active {
            background: rgba(255,255,255,0.4);
            transform: scale(1.05);
        }

        .live-translation-text {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 15px;
            border-radius: 8px;
            min-height: 100px;
            font-size: 1.1em;
            line-height: 1.6;
            direction: rtl;
            text-align: right;
        }
    </style>
</head>
<body>
    <!-- SITE LANGUAGE SELECTOR -->
    <div id="siteLanguageSelector">
        馃實 <select id="siteLangSelect" onchange="changeSiteLanguage()">
            <option value="he">注讘专讬转</option>
            <option value="en">English</option>
            <option value="es">Espa帽ol</option>
            <option value="fr">Fran莽ais</option>
            <option value="de">Deutsch</option>
            <option value="it">Italiano</option>
            <option value="pt">Portugu锚s</option>
            <option value="ru">袪褍褋褋泻懈泄</option>
            <option value="ar">丕賱毓乇亘賷丞</option>
            <option value="ja">鏃ユ湰瑾?/option>
            <option value="zh">涓枃</option>
            <option value="ko">頃滉淡鞏?/option>
            <option value="hi">啶灌た啶ㄠ啶︵</option>
            <option value="nl">Nederlands</option>
            <option value="pl">Polski</option>
        </select>
    </div>
    
    <!-- QUANTUM VISUALIZATION LAYER -->
    <canvas id="quantumVisualizer"></canvas>
    <div id="quantumCore"></div>
    <div id="quantumLangIndicator">馃攳 <span id="quantumLangEmoji">馃寪</span> <span id="quantumLangName">诪讝讛讛...</span> | 讜讚讗讜转: <span id="quantumConfidence">0</span>%</div>
    <div id="quantumMetrics">
        鈿?Latency: <span id="quantumLatency">0.0000</span>ms<br>
        馃К Binary: <span id="quantumBinary">0101</span><br>
        馃實 Lang: <span id="quantumCurrentLang">he-IL</span><br>
        馃幆 Confidence: <span id="quantumConf">0</span>%
    </div>
    
    <div class="app-container">
        <!-- VOICE PANEL (LEFT) -->
        <div class="voice-panel" id="voicePanel">
            <div class="panel-header">馃帳 讟拽住讟 讘讝诪谉 讗诪转</div>
            
            <div class="panel-content">
                <!-- INPUT MODE TOGGLE -->
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <button class="control-btn" id="voiceMode" onclick="switchMode('voice')" style="flex: 1; background: #667eea; color: white; border: none;">
                        馃帳 讛拽诇讟讛
                    </button>
                    <button class="control-btn" id="textMode" onclick="switchMode('text')" style="flex: 1; border-color: #667eea; color: #667eea;">
                        鈱笍 讛拽诇讟
                    </button>
                </div>
                
                <!-- TEXT INPUT SECTION (hidden by default) -->
                <div id="textInputSection" style="display: none; margin-bottom: 12px;">
                    <div class="status-indicator" id="statusIndicatorText" style="margin-bottom: 8px;">
                        鉁?Ready
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <input 
                            type="text" 
                            id="panelTextInput" 
                            placeholder="讻转讜讘 诪砖讛讜..."
                            style="flex: 1; padding: 10px; border: 2px solid #667eea; border-radius: 8px; font-family: inherit; direction: rtl; text-align: right;"
                            onkeypress="if(event.key==='Enter') sendMessageFromPanel()"
                        />
                        <button class="send-btn" onclick="sendMessageFromPanel()" style="padding: 10px 15px;">
                            鉁夛笍
                        </button>
                    </div>
                </div>
                
                <!-- VOICE RECORDING SECTION (shown by default) -->
                <div id="voiceRecordingSection">
                    <!-- STATUS -->
                    <div class="status-indicator" id="statusIndicatorVoice">
                        鉁?Ready
                    </div>
                    
                    <!-- RECORD BUTTON -->
                    <button class="control-btn" id="recordBtn" onclick="toggleRecording()">
                        馃帳 讛拽诇讟
                    </button>
                    
                    <!-- LIVE STREAMING BUTTON -->
                    <button class="control-btn" id="liveStreamBtn" onclick="toggleLiveStream()" style="border-color: #FF0000; color: #FF0000; margin-top: 8px;">
                        馃敶 砖讬讚讜专 讞讬
                    </button>
                    
                    <button class="control-btn" onclick="clearTranscription()" style="border-color: #ff9800; color: #ff9800; margin-top: 8px;">
                        馃攧 谞拽讛 讟拽住讟
                    </button>
                </div>
                
                <!-- DEVICE SELECTION -->
                <div class="section-title">馃攰 讘讞讬专转 讻专讟讬住 拽讜诇</div>
                <select class="lang-select" id="audioDeviceSelect" onchange="changeAudioDevice()">
                    <option value="">馃攧 讝讛讜讬 讗讜讟讜诪讟讬</option>
                </select>
                
                <div class="section-title">馃摴 讘讞讬专转 讻专讟讬住 讜讬讚讗讜</div>
                <select class="lang-select" id="videoDeviceSelect" onchange="changeVideoDevice()">
                    <option value="">馃攧 讝讛讜讬 讗讜讟讜诪讟讬</option>
                </select>
                
                <button class="control-btn" onclick="enumerateDevices()" style="border-color: #00bfff; color: #00bfff; margin-top: 8px;">
                    馃攳 住专讜拽 讛转拽谞讬诐
                </button>

                <!-- AUDIO OPTIMIZATION -->
                <div class="section-title" style="margin-top: 12px;">鈿欙笍 讗讜驻讟讬诪讬讝爪讬讛 拽讜诇</div>
                <div style="font-size: 0.85em; color: #667eea; background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                    <div>馃帣锔?Noise Suppression: <strong id="noiseSuppression">鉁?/strong></div>
                    <div>馃搳 Auto Gain: <strong id="autoGain">鉁?/strong></div>
                    <div>馃攰 Sample Rate: <strong id="sampleRate">48KHz</strong></div>
                    <div>馃搱 Bit Depth: <strong id="bitDepth">16-bit</strong></div>
                </div>

                <!-- VIDEO OPTIMIZATION -->
                <div class="section-title">馃帴 讗讜驻讟讬诪讬讝爪讬讛 讜讬讚讗讜</div>
                <div style="font-size: 0.85em; color: #667eea; background: #f8f9fa; padding: 10px; border-radius: 6px; margin-bottom: 8px;">
                    <div>馃摴 Resolution: <strong id="videoResolution">1920x1080</strong></div>
                    <div>鈿?Frame Rate: <strong id="frameRate">60fps</strong></div>
                    <div>馃挕 Lighting: <strong id="lighting">Auto</strong></div>
                    <div>馃幆 Focus: <strong id="focus">Auto</strong></div>
                </div>

                <!-- VOICE LANGUAGE -->
                <div class="section-title">砖驻转 拽讜诇</div>
                <select class="lang-select" id="voiceLang" onchange="changeVoiceLanguage()">
                    <option value="he-IL">馃嚠馃嚤 注讘专讬转 (Hebrew)</option>
                    <option value="en-US">馃嚭馃嚫 English (讗谞讙诇讬转)</option>
                    <option value="es-ES">馃嚜馃嚫 Espa帽ol (住驻专讚讬转)</option>
                    <option value="fr-FR">馃嚝馃嚪 Fran莽ais (爪专驻转讬转)</option>
                    <option value="de-DE">馃嚛馃嚜 Deutsch (讙专诪谞讬转)</option>
                    <option value="it-IT">馃嚠馃嚬 Italiano (讗讬讟诇拽讬转)</option>
                    <option value="pt-PT">馃嚨馃嚬 Portugu锚s (驻讜专讟讜讙讝讬转)</option>
                    <option value="ru-RU">馃嚪馃嚭 袪褍褋褋泻懈泄 (专讜住讬转)</option>
                    <option value="ar-SA">馃嚫馃嚘 丕賱毓乇亘賷丞 (注专讘讬转)</option>
                    <option value="ja-JP">馃嚡馃嚨 鏃ユ湰瑾?(讬驻谞讬转)</option>
                    <option value="zh-CN">馃嚚馃嚦 涓枃 (住讬谞讬转)</option>
                    <option value="ko-KR">馃嚢馃嚪 頃滉淡鞏?(拽讜专讬讗谞讬转)</option>
                    <option value="hi-IN">馃嚠馃嚦 啶灌た啶ㄠ啶︵ (讛讬谞讚讬转)</option>
                    <option value="nl-NL">馃嚦馃嚤 Nederlands (讛讜诇谞讚讬转)</option>
                    <option value="pl-PL">馃嚨馃嚤 Polski (驻讜诇谞讬转)</option>
                </select>
                
                <!-- TRANSLATION LANGUAGE -->
                <div class="section-title" style="margin-top: 15px;">转专讙讜诐</div>
                <select class="lang-select" id="translateLang" onchange="changeTranslateLanguage()">
                    <option value="">馃實 诇讗 诇转专讙诐</option>
                    <option value="he">馃嚠馃嚤 注讘专讬转</option>
                    <option value="en">馃嚭馃嚫 English</option>
                    <option value="es">馃嚜馃嚫 Espa帽ol</option>
                    <option value="fr">馃嚝馃嚪 Fran莽ais</option>
                    <option value="de">馃嚛馃嚜 Deutsch</option>
                    <option value="it">馃嚠馃嚬 Italiano</option>
                    <option value="pt">馃嚨馃嚬 Portugu锚s</option>
                    <option value="ru">馃嚪馃嚭 袪褍褋褋泻懈泄</option>
                    <option value="ar">馃嚫馃嚘 丕賱毓乇亘賷丞</option>
                    <option value="ja">馃嚡馃嚨 鏃ユ湰瑾?/option>
                    <option value="zh">馃嚚馃嚦 涓枃</option>
                    <option value="ko">馃嚢馃嚪 頃滉淡鞏?/option>
                    <option value="hi">馃嚠馃嚦 啶灌た啶ㄠ啶︵</option>
                    <option value="nl">馃嚦馃嚤 Nederlands</option>
                    <option value="pl">馃嚨馃嚤 Polski</option>
                </select>
                
                <div class="transcription-box" id="translatedBox" style="display: none; margin-top: 12px;">
                    <div class="transcription-label">转专讙讜诐 讘讝诪谉 讗诪转</div>
                    <div id="translatedText"></div>
                </div>
                
                <!-- TRANSCRIPTION -->
                <div class="section-title" style="margin-top: 15px;">讟专谞住拽专讬驻爪讬讛</div>
                
                <div class="transcription-box" style="min-height: 200px; max-height: 300px;">
                    <div class="transcription-label">讟拽住讟 讘讝诪谉 讗诪转</div>
                    <div id="finalTranscript"></div>
                </div>
                
                <!-- FILE MANAGEMENT -->
                <div class="section-title">砖诪讬专讛</div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                    <button class="control-btn" onclick="saveTranscriptionTXT()" style="border-color: #28a745; color: #28a745; margin-bottom: 0;">
                        馃搫 TXT
                    </button>
                    <button class="control-btn" onclick="saveTranscriptionDOCX()" style="border-color: #28a745; color: #28a745; margin-bottom: 0;">
                        馃搵 DOCX
                    </button>
                </div>
                
                <!-- FILE UPLOADS -->
                <div class="section-title" style="cursor: pointer; user-select: none;" onclick="toggleUploadAccordion(this)">
                    鈻?讛注诇讗讛
                </div>
                
                <div id="uploadAccordion" style="display: none; margin-bottom: 15px;">
                    <div class="file-upload-box" onclick="document.getElementById('audioInput').click()">
                        馃幍 住讗讜谞讚 (MP3, WAV, M4A)
                        <input type="file" id="audioInput" accept="audio/*" onchange="handleAudioUpload(event)">
                    </div>
                    
                    <div class="file-upload-box" onclick="document.getElementById('videoInput').click()">
                        馃幀 住专讟 (MP4, WebM, MOV)
                        <input type="file" id="videoInput" accept="video/*" onchange="handleVideoUpload(event)">
                    </div>
                    
                    <div class="file-upload-box" onclick="document.getElementById('txtInput').click()">
                        馃搫 讟拽住讟 TXT
                        <input type="file" id="txtInput" accept=".txt" onchange="handleTxtUpload(event)">
                    </div>
                    
                    <div class="file-upload-box" onclick="document.getElementById('docxInput').click()">
                        馃搵 DOCX Word
                        <input type="file" id="docxInput" accept=".docx" onchange="handleDocxUpload(event)">
                    </div>
                </div>
                
                <!-- FILES LIST -->
                <div class="section-title">拽讘爪讬诐</div>
                <div id="filesList" class="files-list">
                    <div class="empty-files">讗讬谉 拽讘爪讬诐 注讚讬讬谉</div>
                </div>
                
                <button class="control-btn" onclick="clearAllFiles()" style="border-color: #ff6b6b; color: #ff6b6b;">
                    馃棏锔?诪讞拽 讛讻诇
                </button>
                
                <!-- ADVANCED: VIDEO/STREAM SECTION -->
                <div class="section-title" style="margin-top: 15px; cursor: pointer; user-select: none;" onclick="toggleStreamAccordion(this)">
                    鈻?讜讬讚讗讜 / 砖讚讜专 讞讬
                </div>
                
                <div id="streamAccordion" style="display: none;">
                    <div style="margin-bottom: 8px;">
                        <div style="font-weight: bold; color: #667eea; margin-bottom: 6px;">馃幀 住讜讙讬 拽诇讟:</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                            <button class="control-btn" onclick="showYouTubeInput()" style="border-color: #FF0000; color: #FF0000; margin-bottom: 0; font-size: 0.9em;">
                                馃摵 YouTube
                            </button>
                            <button class="control-btn" onclick="showLiveStreamInput()" style="border-color: #00AA00; color: #00AA00; margin-bottom: 0; font-size: 0.9em;">
                                馃摗 砖讚讜专 讞讬
                            </button>
                        </div>
                    </div>
                    
                    <div id="youtubeInputArea" style="display: none; margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #FF0000;">
                        <input type="text" id="youtubeURL" placeholder="https://www.youtube.com/watch?v=    ..." 
                            style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #FF0000; margin-bottom: 8px; font-size: 0.9em;">
                        <button class="control-btn" onclick="loadYouTubeVideo()" style="width: 100%; margin-bottom: 0; border-color: #FF0000; color: #FF0000;">
                            鈻?讛驻注诇 YouTube
                        </button>
                    </div>
                    
                    <div id="liveStreamInputArea" style="display: none; margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #00AA00;">
                        <input type="text" id="streamURL2" placeholder="https://example.com/stream     讗讜 https://example.com/video.mp4    " 
                            style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #00AA00; margin-bottom: 8px; font-size: 0.9em;">
                        <button class="control-btn" onclick="loadLiveStream()" style="width: 100%; margin-bottom: 0; border-color: #00AA00; color: #00AA00;">
                            鈻?讛驻注诇 砖讚讜专
                        </button>
                    </div>
                    
                    <div style="margin-bottom: 8px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-weight: bold; margin-bottom: 6px; color: #667eea;">馃摑 讻转讜讘讬讜转/讟拽住讟:</div>
                        <textarea id="videoSubtitles" placeholder="讛讚讘拽 讻转讜讘讬讜转 讗讜 讟拽住讟 诪讛住专讟讜谉..." 
                            style="width: 100%; height: 100px; padding: 8px; border-radius: 6px; border: 1px solid #667eea; resize: vertical; font-size: 0.9em;"></textarea>
                        <button class="control-btn" onclick="processVideoSubtitles()" style="width: 100%; margin-top: 8px; margin-bottom: 0;">
                            鉁?注讚讻谉 讻转讜讘讬讜转
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                        <button class="control-btn" id="audioStreamBtn" onclick="startAudioStreaming()" style="border-color: #667eea; color: #667eea; margin-bottom: 0; font-size: 0.9em;">
                            馃帣锔?讛拽诇讟 讗讜讚讬讜
                        </button>
                        <button class="control-btn" onclick="stopAudioStreaming()" style="border-color: #ff6b6b; color: #ff6b6b; margin-bottom: 0; font-size: 0.9em;">
                            鈴癸笍 注爪讜专
                        </button>
                    </div>
                    
                    <div id="videoContainer">
                        <div id="videoPlayerWrapper" style="width: 100%; background: #000; border-radius: 8px; margin-bottom: 8px; overflow: hidden; min-height: 480px;">
                            <video id="videoPlayer" width="100%" height="480" controls style="background: #000; display: block;"></video>
                        </div>
                        
                        <!-- 鉁?EXPANDED TRANSLATION PANEL -->
                        <div class="video-translation-panel">
                            <h3>馃寪 转专讙讜诐 讘讝诪谉 讗诪转</h3>
                            <div class="translation-lang-tabs">
                                <button class="translation-lang-tab active" onclick="switchVideoTransLang(event, 'he')">馃嚠馃嚤 注讘专讬转</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'en')">馃嚭馃嚫 English</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'ar')">馃嚫馃嚘 丕賱毓乇亘賷丞</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'ru')">馃嚪馃嚭 袪褍褋褋泻懈泄</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'es')">馃嚜馃嚫 Espa帽ol</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'fr')">馃嚝馃嚪 Fran莽ais</button>
                                <button class="translation-lang-tab" onclick="switchVideoTransLang(event, 'de')">馃嚛馃嚜 Deutsch</button>
                            </div>
                            <div class="live-translation-text" id="liveVideoTranslation">
                                讛转专讙讜诐 讬讜驻讬注 讻讗谉 讘讝诪谉 讗诪转...
                            </div>
                        </div>
                        
                        <div class="transcription-box" style="min-height: 120px; max-height: 220px; margin-bottom: 8px; background: #1a1a1a; border: 2px solid #FFD700;">
                            <div class="transcription-label" style="color: #FFD700; text-shadow: 0 0 5px #FFD700;">馃摵 讻转讜讘讬讜转 讘讝诪谉 讗诪转 (TV Subtitles)</div>
                            <div id="videoTranscript"></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <button class="control-btn" onclick="saveVideoTranscriptTXT()" style="border-color: #28a745; color: #28a745; margin-bottom: 0;">
                                馃搫 砖诪讜专 TXT
                            </button>
                            <button class="control-btn" onclick="saveVideoTranscriptDOCX()" style="border-color: #28a745; color: #28a745; margin-bottom: 0;">
                                馃搵 砖诪讜专 DOCX
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- MAIN CHAT AREA -->
        <div class="main-container">
            <button class="toggle-panel-btn" onclick="togglePanel()">
                馃帳
            </button>
            
            <!-- HEADER -->
            <div class="header">
                <h1>馃挍 讞讬-讗诪转 VOICE</h1>
                <p>Real-Time Transcription + Translation + File Upload</p>
                <div class="badge">
                    馃摑 Transcribed | 馃攰 No Speech Output | Binary: 0101-0101(0101)
                </div>
            </div>
            
            <!-- CHAT AREA -->
            <div class="chat-area" id="chatArea">
                <div class="message assistant">
                    <div class="message-wrapper">
                        <div class="message-content">
                            砖诇讜诐! 馃挍 讗谞讬 讞讬-讗诪转. 讛拽诇讟 拽讜诇, 讛注诇讛 拽讘爪讬诐, 讗讜 转专讙诐 讟拽住讟 讘讝诪谉 讗诪转!
                        </div>
                        <div class="message-time">注讻砖讬讜</div>
                    </div>
                </div>
            </div>
            
            <!-- INPUT AREA -->
            <div class="input-area">
                <div class="input-wrapper">
                    <input 
                        type="text" 
                        id="messageInput" 
                        placeholder="讻转讜讘 诪砖讛讜..."
                        autocomplete="off"
                    />
                    <button class="send-btn" onclick="sendMessage()">鉁夛笍</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 馃帣锔?SIMPLE RECORDING - no Web Worker needed
        let simpleMediaRecorder = null;
        let simpleAudioChunks = [];
        let simpleStream = null;
        let isSimpleRecording = false;
        let wakeLock = null; // Wake Lock for continuous recording
        
        const API_URL = 'https://haiemetweb.onrender.com/exec';
        const TOKEN = 'chai_emet_cXVhbnR1bV9tYXN0ZXI:Rk9SRVZFUl9RVUFOVFVNXzVEOnZiamZwbWNnNjhp';
        const BINARY_SIG = "0101-0101(0101)";
        
        const LANGUAGES_CONFIG = {
            'he-IL': { name: '馃嚠馃嚤 注讘专讬转', emoji: '馃挍', label: 'Hebrew' },
            'en-US': { name: '馃嚭馃嚫 English', emoji: '馃挋', label: 'English' },
            'es-ES': { name: '馃嚜馃嚫 Espa帽ol', emoji: '馃尯', label: 'Spanish' },
            'fr-FR': { name: '馃嚝馃嚪 Fran莽ais', emoji: '馃', label: 'French' },
            'de-DE': { name: '馃嚛馃嚜 Deutsch', emoji: '馃嵑', label: 'German' },
            'it-IT': { name: '馃嚠馃嚬 Italiano', emoji: '馃崫', label: 'Italian' },
            'pt-PT': { name: '馃嚨馃嚬 Portugu锚s', emoji: '馃彇锔?, label: 'Portuguese' },
            'ru-RU': { name: '馃嚪馃嚭 袪褍褋褋泻懈泄', emoji: '鉂勶笍', label: 'Russian' },
            'ar-SA': { name: '馃嚫馃嚘 丕賱毓乇亘賷丞', emoji: '馃寵', label: 'Arabic' },
            'ja-JP': { name: '馃嚡馃嚨 鏃ユ湰瑾?, emoji: '馃尭', label: 'Japanese' },
            'zh-CN': { name: '馃嚚馃嚦 涓枃', emoji: '馃彯', label: 'Chinese' },
            'ko-KR': { name: '馃嚢馃嚪 頃滉淡鞏?, emoji: '馃専', label: 'Korean South' },
            'ko-KP': { name: '馃嚢馃嚨 臁办劆毵?, emoji: '猸?, label: 'Korean North' },
            'hi-IN': { name: '馃嚠馃嚦 啶灌た啶ㄠ啶︵', emoji: '馃帹', label: 'Hindi' },
            'nl-NL': { name: '馃嚦馃嚤 Nederlands', emoji: '馃尫', label: 'Dutch' },
            'pl-PL': { name: '馃嚨馃嚤 Polski', emoji: '馃尣', label: 'Polish' }
        };

        let currentVideoTransLang = 'he';
        
        // 鉁?Switch video translation language
        function switchVideoTransLang(event, lang) {
            currentVideoTransLang = lang;
            
            // Update active tab
            document.querySelectorAll('.translation-lang-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update translation display
            const translations = {
                'he': '讛转专讙讜诐 诇注讘专讬转 讬讜驻讬注 讻讗谉...',
                'en': 'English translation will appear here...',
                'ar': '丕賱鬲乇噩賲丞 丕賱毓乇亘賷丞 爻鬲馗賴乇 賴賳丕...',
                'ru': '袩械褉械胁芯写 薪邪 褉褍褋褋泻懈泄 锌芯褟胁懈褌褋褟 蟹写械褋褜...',
                'es': 'La traducci贸n al espa帽ol aparecer谩 aqu铆...',
                'fr': 'La traduction en fran莽ais appara卯tra ici...',
                'de': 'Die deutsche 脺bersetzung wird hier erscheinen...'
            };
            
            const translationText = document.getElementById('liveVideoTranslation');
            if (translationText) {
                translationText.textContent = translations[lang] || 'Translation will appear here...';
            }
            
            addMessage(`馃寪 砖驻转 转专讙讜诐 砖讜谞转讛 诇-${event.target.textContent}`, false);
        }
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let recognitionPool = new Map();
        let isRecording = false;
        let isWebSpeechActive = false;
        let transcriptionHistory = [];
        let uploadedFiles = [];
        let currentVoiceLang = 'he-IL';
        let selectedTranslateLang = '';
        let userId = 'user_' + Math.random().toString(36).substr(2, 9);
        let videoTranscriptHistory = [];
        let currentVideoSubtitles = '';
        let currentVideoTranslations = {};
        let mediaRecorder = null;
        let audioChunks = [];
        let isAudioRecording = false;
        let selectedAudioDevice = '';
        let selectedVideoDevice = '';
        let availableAudioDevices = [];
        let availableVideoDevices = [];

        function setupWebSpeechPool() {
            if (!SpeechRecognition) {
                console.warn('鈿狅笍 Web Speech API 诇讗 谞转诪讱 讘讚驻讚驻谉');
                return false;
            }
            
            console.log('馃幆 诪讻讬谉 Web Speech API Pool...');
            
            Object.entries(LANGUAGES_CONFIG).forEach(([langCode, langData]) => {
                try {
                    const rec = new SpeechRecognition();
                    rec.lang = langCode;
                    rec.continuous = true;
                    rec.interimResults = true;
                    rec.maxAlternatives = 3;
                    
                    recognitionPool.set(langCode, rec);
                    console.log(`鉁?Web Speech engine ready: ${langCode}`);
                    
                } catch (e) {
                    console.warn(`鈿狅笍 诇讗 讛爪诇讞转讬 诇讬爪讜专 诪谞讜注 ${langCode}: ${e.message}`);
                }
            });
            
            recognition = recognitionPool.get('he-IL') || recognitionPool.get('en-US');
            console.log(`鉁?Web Speech Pool 诪讜讻谉! ${recognitionPool.size} 诪谞讜注讬诐`);
            return true;
        }
        
        const webSpeechReady = setupWebSpeechPool();

        async function enumerateDevices() {
            try {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        audio: true, 
                        video: true 
                    });
                    stream.getTracks().forEach(track => track.stop());
                } catch (permError) {
                    console.log('Permission request: ', permError.message);
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                
                availableAudioDevices = devices.filter(device => device.kind === 'audioinput');
                availableVideoDevices = devices.filter(device => device.kind === 'videoinput');
                const audioOutputDevices = devices.filter(device => device.kind === 'audiooutput');
                
                const audioSelect = document.getElementById('audioDeviceSelect');
                if (audioSelect) {
                    audioSelect.innerHTML = '<option value="">馃攧 讝讛讜讬 讗讜讟讜诪讟讬</option>';
                    availableAudioDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        const label = device.label || `诪讬拽专讜驻讜谉 ${index + 1}`;
                        option.text = `馃帣锔?${label}`;
                        audioSelect.appendChild(option);
                    });
                }
                
                const videoSelect = document.getElementById('videoDeviceSelect');
                if (videoSelect) {
                    videoSelect.innerHTML = '<option value="">馃攧 讝讛讜讬 讗讜讟讜诪讟讬</option>';
                    availableVideoDevices.forEach((device, index) => {
                        const option = document.createElement('option');
                        option.value = device.deviceId;
                        const label = device.label || `诪爪诇诪讛 ${index + 1}`;
                        option.text = `馃摴 ${label}`;
                        videoSelect.appendChild(option);
                    });
                }
                
                let deviceMsg = '馃攳 讝讬讛讜讬 讻专讟讬住讬 拽讜诇:\n\n';
                deviceMsg += `馃帣锔?**诪讬拽专讜驻讜谞讬诐 (${availableAudioDevices.length}):**\n`;
                availableAudioDevices.forEach((device, i) => {
                    const label = device.label || `诪讬拽专讜驻讜谉 ${i + 1}`;
                    deviceMsg += `  ${i + 1}. ${label}\n`;
                });
                
                deviceMsg += `\n馃摴 **诪爪诇诪讜转 (${availableVideoDevices.length}):**\n`;
                availableVideoDevices.forEach((device, i) => {
                    const label = device.label || `诪爪诇诪讛 ${i + 1}`;
                    deviceMsg += `  ${i + 1}. ${label}\n`;
                });
                
                if (audioOutputDevices.length > 0) {
                    deviceMsg += `\n馃攰 **专诪拽讜诇讬诐 (${audioOutputDevices.length}):**\n`;
                    audioOutputDevices.forEach((device, i) => {
                        const label = device.label || `专诪拽讜诇 ${i + 1}`;
                        deviceMsg += `  ${i + 1}. ${label}\n`;
                    });
                }
                
                const totalDevices = availableAudioDevices.length + availableVideoDevices.length + audioOutputDevices.length;
                if (totalDevices > 0) {
                    addMessage(deviceMsg, false);
                    safeSetText('statusIndicatorVoice', `鉁?${totalDevices} 讛转拽谞讬诐 讝讜讛讜`);
                    
                    const metricsEl = document.getElementById('quantumMetrics');
                    if (metricsEl) {
                        metricsEl.innerHTML = `
                            馃帣锔?Audio: ${availableAudioDevices.length}<br>
                            馃摴 Video: ${availableVideoDevices.length}<br>
                            馃攰 Output: ${audioOutputDevices.length}<br>
                            鉁?Total: ${totalDevices}
                        `;
                    }
                } else {
                    addMessage(`鈿狅笍 诇讗 谞诪爪讗讜 讛转拽谞讬诐 - 谞讗 转谉 讛专砖讗讛`, false);
                }
                
            } catch (error) {
                console.error('Device enumeration error:', error);
                addMessage(`鈿狅笍 砖讙讬讗讛 讘讝讬讛讜讬 讛转拽谞讬诐: ${error.message}`, false);
                updateStatus('鈿狅笍 谞讚专砖讜转 讛专砖讗讜转');
            }
        }

        function changeAudioDevice() {
            selectedAudioDevice = document.getElementById('audioDeviceSelect').value;
            const deviceName = availableAudioDevices.find(d => d.deviceId === selectedAudioDevice)?.label || '讗讜讟讜诪讟讬';
            addMessage(`馃帣锔?讘讞专 讻专讟讬住 拽讜诇: ${deviceName}`, false);
            
            localStorage.setItem('hai_emet_audio_device', selectedAudioDevice);
            
            if (window.innerWidth <= 768) {
                document.getElementById('voicePanel').classList.remove('open');
            }
        }
        
        function changeVideoDevice() {
            selectedVideoDevice = document.getElementById('videoDeviceSelect').value;
            const deviceName = availableVideoDevices.find(d => d.deviceId === selectedVideoDevice)?.label || '讗讜讟讜诪讟讬';
            addMessage(`馃摴 讘讞专 讻专讟讬住 讜讬讚讗讜: ${deviceName}`, false);
            
            localStorage.setItem('hai_emet_video_device', selectedVideoDevice);
            
            if (window.innerWidth <= 768) {
                document.getElementById('voicePanel').classList.remove('open');
            }
        }

        function getOptimizedAudioConstraints() {
            return {
                audio: {
                    deviceId: selectedAudioDevice ? { exact: selectedAudioDevice } : undefined,
                    sampleRate: { ideal: 48000 },
                    sampleSize: { ideal: 16 },
                    channelCount: { ideal: 2 },
                    noiseSuppression: { ideal: true },
                    echoCancellation: { ideal: true },
                    autoGainControl: { ideal: true },
                    latency: { ideal: 0.01 }
                },
                video: false
            };
        }

        function updateStatus(text) {
            try {
                const voiceStatus = document.getElementById('statusIndicatorVoice');
                const textStatus = document.getElementById('statusIndicatorText');
                const fallbackStatus = document.getElementById('statusIndicator');
                
                if (voiceStatus) voiceStatus.textContent = text;
                if (textStatus) textStatus.textContent = text;
                if (fallbackStatus) fallbackStatus.textContent = text;
            } catch (e) {
                console.log('Status update: ' + text);
            }
        }

        window.safeSetText = function(elementId, text) {
            try {
                const el = document.getElementById(elementId);
                if (el) {
                    el.textContent = text;
                    console.log(`鉁?safeSetText: ${elementId} = "${text.substring(0, 50)}..."`);
                    return true;
                } else {
                    console.error(`鉂?safeSetText: Element ${elementId} not found!`);
                }
            } catch (e) {
                console.warn(`鈿狅笍 Safe text update failed for ${elementId}: ${e.message}`);
            }
            return false;
        };

        window.addEventListener('DOMContentLoaded', () => {
            enumerateDevices();
            
            setTimeout(() => {
                const savedAudioDevice = localStorage.getItem('hai_emet_audio_device');
                const savedVideoDevice = localStorage.getItem('hai_emet_video_device');
                
                if (savedAudioDevice) {
                    selectedAudioDevice = savedAudioDevice;
                    const audioSelect = document.getElementById('audioDeviceSelect');
                    if (audioSelect) {
                        audioSelect.value = savedAudioDevice;
                        addMessage(`馃帣锔?讟注讜谉 讛转拽谉 砖诪讜专: ${availableAudioDevices.find(d => d.deviceId === savedAudioDevice)?.label || '讛转拽谉'}`, false);
                    }
                }
                
                if (savedVideoDevice) {
                    selectedVideoDevice = savedVideoDevice;
                    const videoSelect = document.getElementById('videoDeviceSelect');
                    if (videoSelect) {
                        videoSelect.value = savedVideoDevice;
                        addMessage(`馃摴 讟注讜谉 讛转拽谉 砖诪讜专: ${availableVideoDevices.find(d => d.deviceId === savedVideoDevice)?.label || '讛转拽谉'}`, false);
                    }
                }
            }, 1000);
        });

        function getPrecisionTime() {
            return (Date.now() / 1000).toFixed(4);
        }
        
        function getExactTime() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function switchMode(mode) {
            const voiceMode = document.getElementById('voiceMode');
            const textMode = document.getElementById('textMode');
            const voiceSection = document.getElementById('voiceRecordingSection');
            const textSection = document.getElementById('textInputSection');
            
            if (mode === 'voice') {
                voiceMode.style.background = '#667eea';
                voiceMode.style.color = 'white';
                voiceMode.style.borderColor = 'transparent';
                
                textMode.style.background = 'transparent';
                textMode.style.color = '#667eea';
                textMode.style.borderColor = '#667eea';
                
                voiceSection.style.display = 'block';
                textSection.style.display = 'none';
                
                addMessage('馃帳 讛讞诇讬驻讛 诇诪爪讘 讛拽诇讟讛', false);
            } else {
                textMode.style.background = '#667eea';
                textMode.style.color = 'white';
                textMode.style.borderColor = 'transparent';
                
                voiceMode.style.background = 'transparent';
                voiceMode.style.color = '#667eea';
                voiceMode.style.borderColor = '#667eea';
                
                voiceSection.style.display = 'none';
                textSection.style.display = 'block';
                
                setTimeout(() => {
                    const panelInput = document.getElementById('panelTextInput');
                    if (panelInput) panelInput.focus();
                }, 100);
                
                addMessage('鈱笍 讛讞诇讬驻讛 诇诪爪讘 讛拽诇讟', false);
            }
        }

        async function sendMessageFromPanel() {
            const textInput = document.getElementById('panelTextInput');
            const message = textInput.value.trim();
            
            if (!message) return;
            
            addMessage(message, true);
            textInput.value = '';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'chat',
                        user_id: userId,
                        message: message,
                        language: currentVoiceLang.split('-')[0]
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const reply = data.response || '转讙讜讘讛 诇讗 讘专讜专讛';
                    addMessage(reply, false);
                } else {
                    addMessage('鉂?Error: Server error', false);
                }
            } catch (error) {
                addMessage(`鉂?Error: ${error.message}`, false);
            }
        }

        function togglePanel() {
            const panel = document.getElementById('voicePanel');
            panel.classList.toggle('open');
        }

        function toggleRecording() {
            if (isSimpleRecording && simpleMediaRecorder) {
                simpleMediaRecorder.stop();
                isSimpleRecording = false;
                document.getElementById('recordBtn').classList.remove('recording');
                safeSetText('recordBtn', '馃帳 讛拽诇讟');
                updateStatus('鈴癸笍 砖讜诇讞 诇砖专转...');
                
                if (isWebSpeechActive && recognitionPool.has(currentVoiceLang)) {
                    try {
                        const rec = recognitionPool.get(currentVoiceLang);
                        rec.stop();
                        isWebSpeechActive = false;
                        console.log('馃帳 Web Speech API 谞注爪专');
                    } catch (e) {
                        console.warn(`鈿狅笍 砖讙讬讗讛 讘注爪讬专转 Web Speech: ${e.message}`);
                    }
                }
                
                if (wakeLock) {
                    wakeLock.release().then(() => {
                        wakeLock = null;
                        console.log('馃敁 Wake Lock released');
                    });
                }
                
                return;
            }
            
            navigator.mediaDevices.getUserMedia(getOptimizedAudioConstraints())
                .then(async stream => {
                    simpleStream = stream;
                    simpleAudioChunks = [];
                    
                    try {
                        if ('wakeLock' in navigator) {
                            wakeLock = await navigator.wakeLock.request('screen');
                            console.log('馃敀 Wake Lock acquired - recording will continue');
                            addMessage('馃敀 讛拽诇讟讛 诪讜讙谞转 - 转诪砖讬讱 讙诐 讗诐 转注讘讜专 诇诇砖讜谞讬转 讗讞专转', false);
                        }
                    } catch (err) {
                        console.log('Wake Lock not supported or denied');
                    }
                    
                    let mimeType = 'audio/webm;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/webm';
                    }
                    if (!MediaRecorder.isTypeSupported(mimeType)) {
                        mimeType = 'audio/mp4';
                    }
                    
                    simpleMediaRecorder = new MediaRecorder(stream, { mimeType });
                    
                    simpleMediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) {
                            simpleAudioChunks.push(e.data);
                        }
                    };
                    
                    simpleMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(simpleAudioChunks, { type: simpleMediaRecorder.mimeType });
                        
                        const formData = new FormData();
                        formData.append('audio', audioBlob, 'recording.webm');
                        formData.append('language', currentVoiceLang);
                        formData.append('user_id', userId);
                        formData.append('browser', 'simple');
                        
                        try {
                            updateStatus('馃摛 诪注诇讛 诇砖专转...');
                            
                            const response = await fetch('https://haiemetweb.onrender.com/transcribe', {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                const transcribedText = result.text || '[讛拽诇讟讛 讛转拽讘诇讛]';
                                
                                const savedText = document.getElementById('finalTranscript').getAttribute('data-saved') || '';
                                const newSavedText = savedText ? savedText + ' ' + transcribedText : transcribedText;
                                safeSetText('finalTranscript', newSavedText);
                                document.getElementById('finalTranscript').setAttribute('data-saved', newSavedText);
                                
                                transcriptionHistory.push({
                                    text: transcribedText,
                                    time: getExactTime(),
                                    lang: currentVoiceLang
                                });
                                
                                addMessage(`馃帣锔?${transcribedText}`, false);
                                
                                if (selectedTranslateLang && transcribedText) {
                                    translateText(transcribedText, selectedTranslateLang);
                                }
                                
                                updateStatus('鉁?讛拽诇讟讛 讛爪诇讬讞讛!');
                            } else {
                                updateStatus(`鉂?砖讙讬讗讛 ${response.status}`);
                            }
                        } catch (error) {
                            updateStatus(`鉂?砖讙讬讗讛: ${error.message}`);
                        } finally {
                            if (simpleStream) {
                                simpleStream.getTracks().forEach(track => track.stop());
                            }
                        }
                    };
                    
                    simpleMediaRecorder.start();
                    isSimpleRecording = true;
                    document.getElementById('recordBtn').classList.add('recording');
                    safeSetText('recordBtn', '鈴癸笍 注爪讜专');
                    updateStatus('馃帶 诪拽诇讬讟... 讚讘专 注讻砖讬讜!');
                    addMessage('馃帣锔?讛拽诇讟讛 讛转讞讬诇讛 - 诪诪砖讬讻讛 讙诐 讘诇砖讜谞讬讜转 讗讞专讜转', false);
                    
                    // 鉁?FIX 2: AUTO-RESTART WEB SPEECH - 诇讗 谞注爪专!
                    if (webSpeechReady && recognitionPool.has(currentVoiceLang)) {
                        const rec = recognitionPool.get(currentVoiceLang);
                        
                        rec.onresult = (event) => {
                            const last = event.results.length - 1;
                            const transcript = event.results[last][0].transcript;
                            const confidence = event.results[last][0].confidence || 0.85;
                            
                            const savedText = document.getElementById('finalTranscript').getAttribute('data-saved') || '';
                            const displayText = savedText ? savedText + ' ' + transcript : transcript;
                            safeSetText('finalTranscript', displayText);
                            
                            if (event.results[last].isFinal) {
                                document.getElementById('finalTranscript').setAttribute('data-saved', displayText);
                                
                                transcriptionHistory.push({
                                    text: transcript,
                                    time: getExactTime(),
                                    lang: currentVoiceLang,
                                    source: 'web-speech'
                                });
                                
                                if (selectedTranslateLang) {
                                    translateText(transcript, selectedTranslateLang);
                                }
                            }
                        };
                        
                        rec.onerror = (event) => {
                            console.warn(`鈿狅笍 Web Speech error: ${event.error}`);
                            // Don't stop on error - keep going!
                        };
                        
                        rec.onend = () => {
                            isWebSpeechActive = false;
                            console.log('馃帳 Web Speech stopped');
                            
                            // 鉁?AUTO-RESTART if still recording!
                            if (isSimpleRecording && simpleMediaRecorder && simpleMediaRecorder.state === 'recording') {
                                console.log('馃攧 Auto-restarting Web Speech...');
                                try {
                                    rec.start();
                                    isWebSpeechActive = true;
                                    console.log('鉁?Web Speech restarted!');
                                } catch (e) {
                                    console.warn(`鈿狅笍 Restart failed: ${e.message}`);
                                }
                            }
                        };
                        
                        try {
                            rec.start();
                            isWebSpeechActive = true;
                            console.log('馃帳 Web Speech API 讛转讞讬诇!');
                            addMessage('馃帳 转诪诇讜诇 讘讝诪谉 讗诪转 驻注讬诇!', false);
                        } catch (e) {
                            console.warn(`鈿狅笍 诇讗 讛爪诇讞转讬 诇讛驻注讬诇 Web Speech: ${e.message}`);
                        }
                    }
                })
                .catch(error => {
                    updateStatus('鉂?砖讙讬讗讛 讘讛专砖讗讜转');
                    addMessage(`鈿狅笍 ${error.message}`, false);
                });
        }

        let isLiveStreaming = false;
        let liveStreamRecorder = null;
        let liveStreamChunks = [];
        let liveStreamInterval = null;
        
        async function toggleLiveStream() {
            if (isLiveStreaming && liveStreamRecorder) {
                isLiveStreaming = false;
                
                if (liveStreamRecorder && liveStreamRecorder.state !== 'inactive') {
                    liveStreamRecorder.stop();
                }
                
                if (liveStreamInterval) {
                    clearInterval(liveStreamInterval);
                    liveStreamInterval = null;
                }
                
                if (isWebSpeechActive && recognitionPool.has(currentVoiceLang)) {
                    try {
                        const rec = recognitionPool.get(currentVoiceLang);
                        rec.stop();
                        isWebSpeechActive = false;
                        console.log('馃敶 Live Web Speech API 谞注爪专');
                    } catch (e) {
                        console.warn(`鈿狅笍 砖讙讬讗讛 讘注爪讬专转 Live Web Speech: ${e.message}`);
                    }
                }
                
                document.getElementById('liveStreamBtn').classList.remove('recording');
                safeSetText('liveStreamBtn', '馃敶 砖讬讚讜专 讞讬');
                updateStatus('鈴癸笍 砖讬讚讜专 讛讜驻住拽');
                addMessage('鈴癸笍 砖讬讚讜专 讞讬 讛讜驻住拽', false);
                
                const metricsEl = document.getElementById('quantumMetrics');
                if (metricsEl) {
                    metricsEl.innerHTML = metricsEl.innerHTML.replace('馃敶 LIVE', '鈴癸笍 STOPPED');
                }
                
                return;
            }
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia(getOptimizedAudioConstraints());
                
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/mp4';
                }
                
                liveStreamRecorder = new MediaRecorder(stream, { mimeType });
                liveStreamChunks = [];
                let chunkCount = 0;
                
                liveStreamRecorder.ondataavailable = async (e) => {
                    if (e.data.size > 0) {
                        liveStreamChunks.push(e.data);
                        chunkCount++;
                        
                        const audioBlob = new Blob([e.data], { type: mimeType });
                        const formData = new FormData();
                        formData.append('audio', audioBlob, `live_chunk_${Date.now()}.webm`);
                        formData.append('language', currentVoiceLang);
                        formData.append('user_id', userId);
                        formData.append('live_stream', 'true');
                        formData.append('chunk_number', chunkCount);
                        
                        try {
                            updateStatus(`馃敶 砖讬讚讜专 讞讬... [${chunkCount} chunks]`);
                            
                            const response = await fetch('https://haiemetweb.onrender.com/transcribe', {
                                method: 'POST',
                                body: formData
                            });
                            
                            if (response.ok) {
                                const result = await response.json();
                                const transcribedText = result.text || result.transcription || '';
                                
                                if (transcribedText.trim()) {
                                    const savedText = document.getElementById('finalTranscript').getAttribute('data-saved') || '';
                                    const newText = savedText ? savedText + ' ' + transcribedText : transcribedText;
                                    safeSetText('finalTranscript', newText);
                                    document.getElementById('finalTranscript').setAttribute('data-saved', newText);
                                    
                                    addMessage(`馃敶 [砖讬讚讜专 讞讬] ${transcribedText}`, false);
                                    
                                    if (selectedTranslateLang && transcribedText.trim()) {
                                        translateText(transcribedText, selectedTranslateLang);
                                    }
                                    
                                    const metricsEl = document.getElementById('quantumMetrics');
                                    if (metricsEl) {
                                        metricsEl.innerHTML = `
                                            馃敶 LIVE<br>
                                            馃摝 Chunks: ${chunkCount}<br>
                                            馃實 ${currentVoiceLang}<br>
                                            馃幆 Active
                                        `;
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Live stream chunk error:', error);
                        }
                    }
                };
                
                liveStreamRecorder.start(3000);
                isLiveStreaming = true;
                
                document.getElementById('liveStreamBtn').classList.add('recording');
                safeSetText('liveStreamBtn', '鈴癸笍 注爪讜专 砖讬讚讜专');
                updateStatus('馃敶 砖讬讚讜专 讞讬 驻注讬诇!');
                addMessage('馃敶 砖讬讚讜专 讞讬 讛转讞讬诇 - 转诪诇讜诇 讘讝诪谉 讗诪转 讻诇 3 砖谞讬讜转', false);
                
                if (webSpeechReady && recognitionPool.has(currentVoiceLang)) {
                    const rec = recognitionPool.get(currentVoiceLang);
                    
                    rec.onresult = (event) => {
                        const last = event.results.length - 1;
                        const transcript = event.results[last][0].transcript;
                        const confidence = event.results[last][0].confidence || 0.85;
                        
                        const savedText = document.getElementById('finalTranscript').getAttribute('data-saved') || '';
                        const displayText = savedText ? savedText + ' ' + transcript : transcript;
                        safeSetText('finalTranscript', displayText);
                        
                        if (event.results[last].isFinal) {
                            document.getElementById('finalTranscript').setAttribute('data-saved', displayText);
                            
                            addMessage(`馃敶 [Live] ${transcript}`, false);
                            
                            if (selectedTranslateLang && transcript.trim()) {
                                translateText(transcript, selectedTranslateLang);
                            }
                            
                            transcriptionHistory.push({
                                text: transcript,
                                time: getExactTime(),
                                lang: currentVoiceLang,
                                source: 'live-web-speech'
                            });
                        }
                    };
                    
                    rec.onerror = (event) => {
                        console.warn(`鈿狅笍 Live Web Speech error: ${event.error}`);
                    };
                    
                    rec.onend = () => {
                        isWebSpeechActive = false;
                        console.log('馃帳 Live Web Speech stopped');
                    };
                    
                    try {
                        rec.start();
                        isWebSpeechActive = true;
                        console.log('馃敶 Live Web Speech API 讛转讞讬诇!');
                        addMessage('馃帳 转诪诇讜诇 讞讬 讬砖讬专 驻注讬诇!', false);
                    } catch (e) {
                        console.warn(`鈿狅笍 诇讗 讛爪诇讞转讬 诇讛驻注讬诇 Live Web Speech: ${e.message}`);
                    }
                }
                
                const metricsEl = document.getElementById('quantumMetrics');
                if (metricsEl) {
                    metricsEl.innerHTML = `
                        馃敶 LIVE<br>
                        馃摝 Chunks: 0<br>
                        馃實 Streaming...<br>
                        馃幆 Ready
                    `;
                }
                
            } catch (error) {
                updateStatus('鉂?砖讙讬讗讛 讘讛专砖讗讜转');
                addMessage(`鈿狅笍 砖讬讚讜专 讞讬 谞讻砖诇: ${error.message}`, false);
                console.error('Live stream error:', error);
            }
        }

        function clearTranscription() {
            if (confirm('讘讟讜讞 砖专讜爪讛 诇诪讞讜拽 讗转 讻诇 讛讟拽住讟?')) {
                safeSetText('finalTranscript', '');
                document.getElementById('finalTranscript').setAttribute('data-saved', '');
                transcriptionHistory = [];
            }
        }

        function toggleUploadAccordion(element) {
            const accordion = document.getElementById('uploadAccordion');
            const arrow = element.textContent.includes('鈻?) ? '鈻? : '鈻?;
            element.textContent = element.textContent.replace(/[鈻垛柤]/, arrow);
            accordion.style.display = accordion.style.display === 'none' ? 'block' : 'none';
        }

        function changeVoiceLanguage() {
            const newLang = document.getElementById('voiceLang').value;
            currentVoiceLang = newLang;
            
            if (recognitionPool.has(newLang)) {
                recognition = recognitionPool.get(newLang);
                console.log(`馃實 讛讞诇驻转讬 诪谞讜注 诇-${newLang}`);
            }
            
            const langName = LANGUAGES_CONFIG[newLang]?.name || 'Unknown';
            updateStatus(`鉁?Language: ${langName}`);
            addMessage(`馃實 砖驻讛 砖讜谞转讛 诇-${langName}`, false);
        }

        // 鉁?FIX 1: Direct transcription without popup
        async function handleAudioUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const timestamp = Date.now();
            const fileData = {
                name: file.name,
                time: getPrecisionTime(),
                type: 'audio',
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                transcription: '鈴?诪注讘讚 讗讜讚讬讜...',
                id: timestamp
            };
            
            uploadedFiles.push(fileData);
            updateFilesList();
            addMessage(`馃幍 诪注诇讛: ${file.name}...`, false);
            
            const audioURL = URL.createObjectURL(file);
            const audioPlayerHTML = `
                <div id="audioPlayer_${timestamp}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 12px; margin: 12px 0; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);">
                    <div style="font-weight: bold; margin-bottom: 10px; color: white; font-size: 1.1em;">馃幍 ${file.name}</div>
                    <audio controls style="width: 100%; margin-bottom: 12px; border-radius: 8px;" id="audio_${timestamp}">
                        <source src="${audioURL}" type="${file.type}">
                    </audio>
                    
                    <div style="background: rgba(255,255,255,0.2); height: 6px; border-radius: 3px; overflow: hidden; margin-bottom: 10px;">
                        <div id="audioProgress_${timestamp}" style="background: #FFD700; height: 100%; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    
                    <div style="font-size: 0.9em; color: white; margin-bottom: 12px; font-weight: 600;" id="audioStatus_${timestamp}">
                        馃殌 诪转讞讬诇 转诪诇讜诇 诪讛讬专... <span id="audioPercent_${timestamp}" style="color: #FFD700;">0%</span>
                    </div>
                    
                    <div id="transcriptionText_${timestamp}" style="background: rgba(0,0,0,0.3); padding: 12px; border-radius: 8px; color: white; min-height: 100px; max-height: 200px; overflow-y: auto; margin-bottom: 12px; line-height: 1.8; direction: rtl; text-align: right;">
                        <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃摑 转诪诇讜诇 讘讝诪谉 讗诪转:</div>
                        <div id="transcriptionContent_${timestamp}">鈴?诪诪转讬谉 诇转诪诇讜诇...</div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button onclick="downloadAudioTranscription(${timestamp}, 'docx')" style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            馃搵 讛讜专讚 DOCX
                        </button>
                        <button onclick="downloadAudioTranscription(${timestamp}, 'txt')" style="background: #17a2b8; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            馃搫 讛讜专讚 TXT
                        </button>
                    </div>
                </div>
            `;
            
            const transcriptionBox = document.querySelector('.transcription-box');
            if (transcriptionBox && transcriptionBox.parentNode) {
                const playerDiv = document.createElement('div');
                playerDiv.innerHTML = audioPlayerHTML;
                transcriptionBox.parentNode.insertBefore(playerDiv, transcriptionBox.nextSibling);
            }
            
            addMessage(`馃殌 ${file.name} - 诪转讞讬诇 转诪诇讜诇 诪讛讬专 讗讜讟讜诪讟讬...`, false);
            
            // 鉁?WAIT FOR DOM TO BE READY
            setTimeout(() => {
                startFastTranscription(timestamp, file.name, file.type, audioURL);
            }, 100);
        }

        // 鉁?FIX 1: POPUP WITH PROGRESS BAR
        async function startFastTranscription(timestamp, filename, filetype, audioURL) {
            const audio = document.getElementById(`audio_${timestamp}`);
            if (!audio) {
                console.error('Audio element not found:', `audio_${timestamp}`);
                return;
            }
            
            // 鉁?GET AUDIO URL FROM EXISTING ELEMENT IF NOT PROVIDED
            if (!audioURL) {
                const source = audio.querySelector('source');
                if (source && source.src) {
                    audioURL = source.src;
                } else {
                    console.error('No audio source found');
                    return;
                }
            }
            
            console.log('馃幀 Starting fast transcription for:', filename);
            
            // Create beautiful popup with progress
            const popup = document.createElement('div');
            popup.id = `popup_${timestamp}`;
            popup.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.5); z-index: 10000; min-width: 450px; color: white;';
            popup.innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 28px; font-weight: bold; margin-bottom: 10px;">
                        馃殌 转诪诇讜诇 诪讛讬专
                        <span id="recordingDots_${timestamp}" style="color: #FFD700; display: inline-block; width: 30px;"></span>
                    </div>
                    <div style="font-size: 14px; opacity: 0.9;">${filename}</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 20px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>诪讛讬专讜转 讛砖诪注:</span>
                        <span id="speedValue_${timestamp}">2.0x</span>
                    </div>
                    <input type="range" id="speedSlider_${timestamp}" min="1" max="3" step="0.5" value="2" 
                        style="width: 100%; cursor: pointer; margin-bottom: 15px;">
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span>注讜爪诪转 拽讜诇:</span>
                        <span id="volumeValue_${timestamp}">50%</span>
                    </div>
                    <input type="range" id="volumeSlider_${timestamp}" min="0" max="100" step="10" value="50" 
                        style="width: 100%; cursor: pointer; margin-bottom: 20px;">
                    
                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; font-size: 12px; opacity: 0.8; margin-bottom: 5px;">
                            <span>讛转拽讚诪讜转</span>
                            <span id="percentText_${timestamp}" style="font-size: 18px; font-weight: bold; color: #FFD700;">0%</span>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); height: 10px; border-radius: 5px; overflow: hidden;">
                            <div id="popupProgress_${timestamp}" style="background: #FFD700; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; margin-top: 5px;">
                            <span id="currentTime_${timestamp}">0:00</span>
                            <span id="totalTime_${timestamp}">0:00</span>
                        </div>
                    </div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 8px; max-height: 250px; overflow-y: auto; font-size: 14px; line-height: 1.8; direction: rtl; text-align: right;" id="liveTranscript_${timestamp}">
                    <div style="opacity: 0.7; font-size: 12px; margin-bottom: 5px;">馃摑 转诪诇讜诇 讘讝诪谉 讗诪转:</div>
                    <div id="transcriptText_${timestamp}" style="white-space: pre-wrap;">诪诪转讬谉 诇转诪诇讜诇...</div>
                </div>
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; font-size: 13px; line-height: 1.6; direction: rtl; text-align: right;" id="liveTranslation_${timestamp}">
                    <div style="opacity: 0.7; font-size: 11px; margin-bottom: 5px;">馃寪 转专讙讜诐:</div>
                    <div id="translationText_${timestamp}">诪诪转讬谉...</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃幍 谞讙谉 讗讜讚讬讜</div>
                    <audio id="popupAudio_${timestamp}" controls style="width: 100%; border-radius: 8px;">
                        <source src="${audioURL}" type="${filetype}">
                    </audio>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button id="downloadDOCX_${timestamp}" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搵 讛讜专讚 DOCX
                    </button>
                    <button id="downloadTXT_${timestamp}" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搫 讛讜专讚 TXT
                    </button>
                </div>
                
                <div style="display: flex; gap: 10px;">
                    <button id="minimizeBtn_${timestamp}" style="flex: 1; background: #ffc107; color: #333; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                        馃斀 诪讝注专
                    </button>
                    <button id="closeBtn_${timestamp}" style="flex: 1; background: #dc3545; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                        鉁?住讙讜专
                    </button>
                </div>
            `;
            document.body.appendChild(popup);
            
            const speedSlider = document.getElementById(`speedSlider_${timestamp}`);
            const speedValue = document.getElementById(`speedValue_${timestamp}`);
            const volumeSlider = document.getElementById(`volumeSlider_${timestamp}`);
            const volumeValue = document.getElementById(`volumeValue_${timestamp}`);
            const popupProgress = document.getElementById(`popupProgress_${timestamp}`);
            const currentTimeEl = document.getElementById(`currentTime_${timestamp}`);
            const totalTimeEl = document.getElementById(`totalTime_${timestamp}`);
            const transcriptTextEl = document.getElementById(`transcriptText_${timestamp}`);
            const translationTextEl = document.getElementById(`translationText_${timestamp}`);
            const minimizeBtn = document.getElementById(`minimizeBtn_${timestamp}`);
            const closeBtn = document.getElementById(`closeBtn_${timestamp}`);
            const downloadTXTBtn = document.getElementById(`downloadTXT_${timestamp}`);
            const downloadDOCXBtn = document.getElementById(`downloadDOCX_${timestamp}`);
            const popupAudio = document.getElementById(`popupAudio_${timestamp}`);
            
            // 鉁?CREATE AUDIO PLAYER FOR PLAYBACK
            const audioPlayer = new Audio(audioURL);
            audioPlayer.volume = 0.5;
            audioPlayer.playbackRate = 2.0;
            
            let transcribedText = '';
            
            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }
            
            audioPlayer.addEventListener('loadedmetadata', () => {
                totalTimeEl.textContent = formatTime(audioPlayer.duration);
            });
            
            audioPlayer.addEventListener('timeupdate', () => {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                const progressInt = Math.floor(progress);
                
                popupProgress.style.width = progress.toFixed(1) + '%';
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                
                const percentText = document.getElementById(`percentText_${timestamp}`);
                if (percentText) {
                    percentText.textContent = progressInt + '%';
                }
                
                const bottomProgress = document.getElementById(`audioProgress_${timestamp}`);
                const bottomPercent = document.getElementById(`audioPercent_${timestamp}`);
                const bottomStatus = document.getElementById(`audioStatus_${timestamp}`);
                
                if (bottomProgress) {
                    bottomProgress.style.width = progress + '%';
                }
                if (bottomPercent) {
                    bottomPercent.textContent = progressInt + '%';
                }
                if (bottomStatus && progressInt < 100) {
                    bottomStatus.innerHTML = `鈴?诪转诪诇诇... <span id="audioPercent_${timestamp}" style="color: #FFD700;">${progressInt}%</span>`;
                }
            });
            
            speedSlider.addEventListener('input', (e) => {
                const speed = parseFloat(e.target.value);
                speedValue.textContent = speed.toFixed(1) + 'x';
                if (audioPlayer) audioPlayer.playbackRate = speed;
            });
            
            volumeSlider.addEventListener('input', (e) => {
                const vol = parseInt(e.target.value);
                volumeValue.textContent = vol + '%';
                if (audioPlayer) audioPlayer.volume = vol / 100;
            });
            
            // 鉁?DOWNLOAD BUTTONS IN POPUP
            downloadTXTBtn.addEventListener('click', () => {
                const text = transcriptTextEl ? transcriptTextEl.textContent : '';
                if (!text || text === '诪诪转讬谉...') {
                    alert('讗讬谉 转诪诇讜诇 注讚讬讬谉');
                    return;
                }
                
                const content = `讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜\n${'='.repeat(50)}\n拽讜讘抓: ${filename}\n转讗专讬讱: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n\n${text}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transcription_${filename.replace(/\.[^/.]+$/, '')}.txt`;
                link.click();
                URL.revokeObjectURL(link.href);
                addMessage(`馃搫 讛讜专讚: ${link.download}`, false);
            });
            
            downloadDOCXBtn.addEventListener('click', () => {
                const text = transcriptTextEl ? transcriptTextEl.textContent : '';
                if (!text || text === '诪诪转讬谉...') {
                    alert('讗讬谉 转诪诇讜诇 注讚讬讬谉');
                    return;
                }
                
                const doc = new docx.Document({
                    sections: [{
                        children: [
                            new docx.Paragraph({
                                text: '馃幍 讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜',
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: `拽讜讘抓: ${filename}`,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: `转讗专讬讱: ${new Date().toLocaleString('he-IL')}`,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: text,
                                spacing: { after: 200 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `transcription_${filename.replace(/\.[^/.]+$/, '')}.docx`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    addMessage(`馃搵 讛讜专讚: ${link.download}`, false);
                });
            });
            
            // 鉁?MINIMIZE BUTTON - Hide popup and add restore button to panel
            minimizeBtn.addEventListener('click', () => {
                popup.style.display = 'none';
                
                // 鉁?ADD RESTORE BUTTON TO PANEL
                const audioPlayerDiv = document.getElementById(`audioPlayer_${timestamp}`);
                if (audioPlayerDiv) {
                    // Check if restore button already exists
                    let restoreBtn = document.getElementById(`restoreBtn_${timestamp}`);
                    if (!restoreBtn) {
                        restoreBtn = document.createElement('button');
                        restoreBtn.id = `restoreBtn_${timestamp}`;
                        restoreBtn.style.cssText = 'width: 100%; background: #ffc107; color: #333; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 8px;';
                        restoreBtn.textContent = '馃敿 驻转讞 讞诇讜谉 转诪诇讜诇';
                        restoreBtn.addEventListener('click', () => {
                            popup.style.display = 'block';
                            restoreBtn.remove();
                        });
                        audioPlayerDiv.insertBefore(restoreBtn, audioPlayerDiv.firstChild);
                    }
                }
                
                addMessage(`馃斀 ${filename} - 讞诇讜谉 诪诪讜讝注专, 诇讞抓 馃敿 诇驻转讬讞讛`, false);
            });
            
            // 鉁?CLOSE BUTTON - Manual close only
            closeBtn.addEventListener('click', () => {
                if (audioPlayer) {
                    audioPlayer.pause();
                    audioPlayer.currentTime = 0;
                }
                
                // 鉁?CREATE EXACT COPY IN PANEL
                const audioPlayerDiv = document.getElementById(`audioPlayer_${timestamp}`);
                if (audioPlayerDiv) {
                    const transcriptText = transcriptTextEl ? transcriptTextEl.textContent : '';
                    const translationText = translationTextEl ? translationTextEl.textContent : '';
                    
                    // Create panel version with audio player, text, and download buttons
                    const panelHTML = `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 12px;">
                            <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃幍 谞讙谉 讗讜讚讬讜</div>
                            <audio controls style="width: 100%; margin-bottom: 12px; border-radius: 8px;">
                                <source src="${audioURL}" type="${filetype}">
                            </audio>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; max-height: 150px; overflow-y: auto; direction: rtl; text-align: right; line-height: 1.8;">
                                <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃摑 转诪诇讜诇:</div>
                                <div style="color: white;">${transcriptText}</div>
                            </div>
                            
                            ${translationText && translationText !== '诪诪转讬谉...' ? `
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; max-height: 150px; overflow-y: auto; direction: rtl; text-align: right; line-height: 1.8;">
                                <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃寪 转专讙讜诐:</div>
                                <div style="color: white;">${translationText}</div>
                            </div>
                            ` : ''}
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <button onclick="downloadPanelTranscription(${timestamp}, 'docx', '${filename.replace(/'/g, "\\'")}', \`${transcriptText.replace(/`/g, '\\`')}\`)" style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    馃搵 讛讜专讚 DOCX
                                </button>
                                <button onclick="downloadPanelTranscription(${timestamp}, 'txt', '${filename.replace(/'/g, "\\'")}', \`${transcriptText.replace(/`/g, '\\`')}\`)" style="background: #17a2b8; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    馃搫 讛讜专讚 TXT
                                </button>
                            </div>
                            
                            <button onclick="startFastTranscription(${timestamp}, '${filename.replace(/'/g, "\\'")}', '${filetype}')" style="background: #667eea; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;">
                                馃攧 驻转讞 讞诇讜谉 转诪诇讜诇 砖讜讘
                            </button>
                        </div>
                    `;
                    
                    // Find existing panel content and replace or add
                    const existingPanel = document.getElementById(`panelContent_${timestamp}`);
                    if (existingPanel) {
                        existingPanel.remove();
                    }
                    
                    const panelDiv = document.createElement('div');
                    panelDiv.id = `panelContent_${timestamp}`;
                    panelDiv.innerHTML = panelHTML;
                    audioPlayerDiv.appendChild(panelDiv);
                }
                
                // 鉁?REMOVE RESTORE BUTTON IF IT EXISTS
                const restoreBtn = document.getElementById(`restoreBtn_${timestamp}`);
                if (restoreBtn) {
                    restoreBtn.remove();
                }
                
                document.body.removeChild(popup);
                URL.revokeObjectURL(audioURL);
                
                addMessage(`鉁?${filename} - 讞诇讜谉 谞住讙专, 讛转讜讻谉 讘驻讗谞诇`, false);
                
                const fileInput = document.getElementById('audioInput');
                if (fileInput) fileInput.value = '';
            });
            
            // 鉁?AUTO-START TRANSCRIPTION WITH MICROPHONE (LIKE LIVE STREAMING!)
            const dotsEl = document.getElementById(`recordingDots_${timestamp}`);
            let dotCount = 0;
            const dotsInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                dotsEl.textContent = '.'.repeat(dotCount);
            }, 500);
            
            (async () => {
                try {
                    console.log('馃幀 诪转讞讬诇 转诪诇讜诇 讘讝诪谉 讗诪转...');
                    
                    // 鉁?CHECK WEB SPEECH API
                    if (!webSpeechReady || !recognitionPool.has(currentVoiceLang)) {
                        throw new Error('Web Speech API 诇讗 讝诪讬谉');
                    }
                    
                    // 鉁?GET MICROPHONE ACCESS (TO HEAR THE AUDIO PLAYING!)
                    const stream = await navigator.mediaDevices.getUserMedia(getOptimizedAudioConstraints());
                    console.log('馃帳 诪讬拽专讜驻讜谉 诪讜讻谉 诇砖诪讜注 讗转 讛讗讜讚讬讜!');
                    
                    // 鉁?START WEB SPEECH API
                    const rec = recognitionPool.get(currentVoiceLang);
                    
                    rec.onresult = (event) => {
                        const last = event.results.length - 1;
                        const transcript = event.results[last][0].transcript;
                        
                        console.log('馃帳 讝讬讛讜讬:', transcript);
                        
                        if (event.results[last].isFinal) {
                            transcribedText += transcript + ' ';
                            
                            // 鉁?UPDATE POPUP TRANSCRIPTION
                            if (transcriptTextEl) {
                                transcriptTextEl.textContent = transcribedText;
                                transcriptTextEl.style.color = 'white';
                                transcriptTextEl.style.opacity = '1';
                                const container = document.getElementById(`liveTranscript_${timestamp}`);
                                if (container) container.scrollTop = container.scrollHeight;
                            }
                            
                            // 鉁?UPDATE BOTTOM PANEL TRANSCRIPTION
                            const bottomTranscript = document.getElementById(`transcriptionContent_${timestamp}`);
                            if (bottomTranscript) {
                                bottomTranscript.textContent = transcribedText;
                                const transcriptionBox = document.getElementById(`transcriptionText_${timestamp}`);
                                if (transcriptionBox) transcriptionBox.scrollTop = transcriptionBox.scrollHeight;
                            }
                            
                            // 鉁?TRANSLATE IF NEEDED
                            if (selectedTranslateLang && translationTextEl) {
                                translateText(transcript, selectedTranslateLang).then(translated => {
                                    const currentTranslation = translationTextEl.textContent === '诪诪转讬谉...' || translationTextEl.textContent === '讘讞专 砖驻转 转专讙讜诐 讘讛讙讚专讜转' ? '' : translationTextEl.textContent;
                                    translationTextEl.textContent = currentTranslation + ' ' + translated;
                                    const container = document.getElementById(`liveTranslation_${timestamp}`);
                                    if (container) container.scrollTop = container.scrollHeight;
                                }).catch(err => {
                                    console.warn('Translation error:', err);
                                });
                            }
                        } else {
                            // 鉁?UPDATE BOTH FOR INTERIM RESULTS
                            if (transcriptTextEl) {
                                transcriptTextEl.textContent = transcribedText + transcript + '...';
                            }
                            const bottomTranscript = document.getElementById(`transcriptionContent_${timestamp}`);
                            if (bottomTranscript) {
                                bottomTranscript.textContent = transcribedText + transcript + '...';
                            }
                        }
                    };
                    
                    rec.onerror = (event) => {
                        console.error('Web Speech error:', event.error);
                    };
                    
                    rec.onend = () => {
                        console.log('Web Speech ended');
                    };
                    
                    // 鉁?START WEB SPEECH + AUDIO PLAYER TOGETHER!
                    console.log('馃帳 诪驻注讬诇 Web Speech...');
                    rec.start();
                    
                    console.log('鈻讹笍 诪谞讙谉 讗讜讚讬讜...');
                    await audioPlayer.play();
                    
                    console.log('鉁?讗讜讚讬讜 诪谞讜讙谉 + 诪讬拽专讜驻讜谉 诪拽诇讬讟 讘讝诪谉 讗诪转!');
                    addMessage(`馃帳 ${filename} - 转诪诇讜诇 讘讝诪谉 讗诪转 驻注讬诇!`, false);
                    
                    audioPlayer.addEventListener('ended', () => {
                        clearInterval(dotsInterval);
                        dotsEl.textContent = '';
                        
                        // 鉁?STOP WEB SPEECH
                        if (rec) {
                            try {
                                rec.stop();
                                console.log('馃帳 Web Speech 谞注爪专');
                            } catch (e) {
                                console.warn('Error stopping recognition:', e);
                            }
                        }
                        
                        // 鉁?STOP MICROPHONE STREAM
                        if (stream) {
                            stream.getTracks().forEach(track => {
                                track.stop();
                                console.log('馃帳 诪讬拽专讜驻讜谉 谞注爪专');
                            });
                        }
                        
                        // 鉁?UPDATE STATUS
                        const statusText = document.getElementById(`audioStatus_${timestamp}`);
                        const transcriptionDiv = document.getElementById(`transcriptionText_${timestamp}`);
                        const transcriptionContent = document.getElementById(`transcriptionContent_${timestamp}`);
                        const progressBar = document.getElementById(`audioProgress_${timestamp}`);
                        
                        if (progressBar) progressBar.style.width = '100%';
                        if (statusText) {
                            statusText.innerHTML = `鉁?转诪诇讜诇 讛讜砖诇诐! <span style="color: #FFD700;">100%</span>`;
                            statusText.style.color = '#28a745';
                        }
                        if (transcriptionDiv) transcriptionDiv.style.display = 'block';
                        if (transcriptionContent && transcribedText) {
                            transcriptionContent.textContent = transcribedText.trim();
                        }
                        
                        if (transcribedText) {
                            window[`audioTranscription_${timestamp}`] = {
                                filename: filename,
                                text: transcribedText.trim(),
                                timestamp: timestamp
                            };
                            
                            const savedText = document.getElementById('finalTranscript').getAttribute('data-saved') || '';
                            const newText = savedText ? savedText + '\n\n馃搫 ' + filename + ':\n' + transcribedText.trim() : '馃搫 ' + filename + ':\n' + transcribedText.trim();
                            safeSetText('finalTranscript', newText);
                            document.getElementById('finalTranscript').setAttribute('data-saved', newText);
                            
                            addMessage(`鉁?${filename} - 转诪诇讜诇 讛讜砖诇诐!`, false);
                        } else {
                            addMessage(`鈿狅笍 ${filename} - 诇讗 讝讜讛讛 讟拽住讟. 谞住讛 诇讛注诇讜转 讗转 注讜爪诪转 讛拽讜诇!`, false);
                        }
                        
                        // Update buttons
                        if (minimizeBtn) minimizeBtn.textContent = '馃斀 诪讝注专';
                        closeBtn.textContent = '鉁?住讙讜专 (讛讜砖诇诐)';
                        closeBtn.style.background = '#28a745';
                        
                        // Reset file input for next upload
                        const fileInput = document.getElementById('audioInput');
                        if (fileInput) fileInput.value = '';
                    });
                    
                } catch (error) {
                    clearInterval(dotsInterval);
                    dotsEl.textContent = '';
                    console.error('Transcription error:', error);
                    
                    const statusText = document.getElementById(`audioStatus_${timestamp}`);
                    if (statusText) {
                        statusText.innerHTML = '鉂?砖讙讬讗讛: ' + error.message;
                        statusText.style.color = '#dc3545';
                    }
                    
                    // 鉁?UPDATE POPUP WITH ERROR
                    if (transcriptTextEl) {
                        transcriptTextEl.textContent = '鉂?砖讙讬讗讛 讘转诪诇讜诇: ' + error.message;
                        transcriptTextEl.style.color = '#dc3545';
                    }
                    
                    addMessage(`鉂?${filename} - 转诪诇讜诇 谞讻砖诇: ${error.message}`, false);
                    
                    closeBtn.textContent = '鉁?住讙讜专 (砖讙讬讗讛)';
                }
            })();
        }

        function downloadAudioTranscription(timestamp, format) {
            const transcriptionData = window[`audioTranscription_${timestamp}`];
            if (!transcriptionData) {
                alert('讗讬谉 转诪诇讜诇 讝诪讬谉');
                return;
            }
            
            const transcriptionContent = document.getElementById(`transcriptionContent_${timestamp}`);
            const text = transcriptionContent ? transcriptionContent.textContent : transcriptionData.text;
            
            if (!text) {
                alert('讛转诪诇讜诇 注讚讬讬谉 诇讗 诪讜讻谉');
                return;
            }
            
            if (format === 'txt') {
                const content = `讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜\n${'='.repeat(50)}\n拽讜讘抓: ${transcriptionData.filename}\n转讗专讬讱: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n\n${text}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transcription_${transcriptionData.filename.replace(/\.[^/.]+$/, '')}.txt`;
                link.click();
                addMessage(`馃搫 讛讜专讚: ${link.download}`, false);
            } else if (format === 'docx') {
                const doc = new docx.Document({
                    sections: [{
                        children: [
                            new docx.Paragraph({
                                text: '馃幍 讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜',
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: `拽讜讘抓: ${transcriptionData.filename}`,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: `转讗专讬讱: ${new Date().toLocaleString('he-IL')}`,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: text,
                                spacing: { after: 200 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `transcription_${transcriptionData.filename.replace(/\.[^/.]+$/, '')}.docx`;
                    link.click();
                    addMessage(`馃搵 讛讜专讚: ${link.download}`, false);
                });
            }
        }
        
        function downloadPanelTranscription(timestamp, format, filename, text) {
            if (!text || text === '诪诪转讬谉...') {
                alert('讗讬谉 转诪诇讜诇 讝诪讬谉');
                return;
            }
            
            if (format === 'txt') {
                const content = `讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜\n${'='.repeat(50)}\n拽讜讘抓: ${filename}\n转讗专讬讱: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n\n${text}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `transcription_${filename.replace(/\.[^/.]+$/, '')}.txt`;
                link.click();
                URL.revokeObjectURL(link.href);
                addMessage(`馃搫 讛讜专讚: ${link.download}`, false);
            } else if (format === 'docx') {
                const doc = new docx.Document({
                    sections: [{
                        children: [
                            new docx.Paragraph({
                                text: '馃幍 讞讬-讗诪转 - 转诪诇讜诇 讗讜讚讬讜',
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: `拽讜讘抓: ${filename}`,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: `转讗专讬讱: ${new Date().toLocaleString('he-IL')}`,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: text,
                                spacing: { after: 200 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `transcription_${filename.replace(/\.[^/.]+$/, '')}.docx`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    addMessage(`馃搵 讛讜专讚: ${link.download}`, false);
                });
            }
        }

        async function handleVideoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const timestamp = Date.now();
            const fileData = {
                name: file.name,
                time: getPrecisionTime(),
                type: 'video',
                size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                transcription: '鈴?诪注讘讚 讜讬讚讗讜...'
            };
            
            uploadedFiles.push(fileData);
            updateFilesList();
            addMessage(`馃幀 诪注诇讛: ${file.name}...`, false);
            
            const videoURL = URL.createObjectURL(file);
            
            // 鉁?CREATE POPUP FOR VIDEO
            const popup = document.createElement('div');
            popup.id = `videoPopup_${timestamp}`;
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 10000;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                color: white;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            
            const subtitleSimulation = [
                '砖诇讜诐! 讝讛 住专讟讜谉 诇讚讜讙诪讗...',
                '讛诪注专讻转 诪注讘讚转 讗转 讛讜讬讚讗讜 讘讝诪谉 讗诪转',
                '讻转讜讘讬讜转 诪讜驻讬注讜转 讻讗谉 讗讜讟讜诪讟讬转',
                '转诪诇讜诇 诪诇讗 讬讜驻讬注 讘住讬讜诐'
            ];
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 24px;">馃幀 转诪诇讜诇 讜讬讚讗讜 诪讛讬专<span id="recordingDots_${timestamp}" style="color: #FFD700;"></span></h2>
                    <div style="font-size: 14px; opacity: 0.8;">${file.name}</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃搳 讛转拽讚诪讜转</div>
                    <div style="background: rgba(255,255,255,0.2); height: 30px; border-radius: 8px; overflow: hidden; position: relative;">
                        <div id="videoPopupProgress_${timestamp}" style="background: #FFD700; height: 100%; width: 0%; transition: width 0.3s;"></div>
                        <div id="videoPercentText_${timestamp}" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: bold; font-size: 16px; color: #000;">0%</div>
                    </div>
                    <div style="margin-top: 8px; font-size: 14px;" id="videoStatus_${timestamp}">鈴?诪注讘讚...</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃帴 谞讙谉 讜讬讚讗讜</div>
                    <video id="popupVideo_${timestamp}" controls style="width: 100%; max-height: 400px; border-radius: 8px; background: #000;">
                        <source src="${videoURL}" type="${file.type}">
                    </video>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; direction: rtl; text-align: right; line-height: 1.8;">
                    <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃摑 转诪诇讜诇:</div>
                    <div id="videoTranscriptText_${timestamp}" style="color: white;">诪诪转讬谉...</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button id="videoDownloadTXT_${timestamp}" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搫 讛讜专讚 TXT
                    </button>
                    <button id="videoDownloadDOCX_${timestamp}" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搵 讛讜专讚 DOCX
                    </button>
                </div>
                
                <button id="videoCloseBtn_${timestamp}" style="width: 100%; background: #dc3545; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    鉁?住讙讜专
                </button>
            `;
            
            document.body.appendChild(popup);
            
            const progressBar = document.getElementById(`videoPopupProgress_${timestamp}`);
            const percentText = document.getElementById(`videoPercentText_${timestamp}`);
            const statusText = document.getElementById(`videoStatus_${timestamp}`);
            const transcriptText = document.getElementById(`videoTranscriptText_${timestamp}`);
            const downloadTXTBtn = document.getElementById(`videoDownloadTXT_${timestamp}`);
            const downloadDOCXBtn = document.getElementById(`videoDownloadDOCX_${timestamp}`);
            const closeBtn = document.getElementById(`videoCloseBtn_${timestamp}`);
            const popupVideo = document.getElementById(`popupVideo_${timestamp}`);
            
            // 鉁?ANIMATED DOTS
            const dotsEl = document.getElementById(`recordingDots_${timestamp}`);
            let dotCount = 0;
            const dotsInterval = setInterval(() => {
                dotCount = (dotCount + 1) % 4;
                dotsEl.textContent = '.'.repeat(dotCount);
            }, 500);
            
            // 鉁?SIMULATE PROCESSING
            let progress = 0;
            let currentSubIndex = 0;
            let fullTranscript = '';
            
            const progressInterval = setInterval(() => {
                progress += 5;
                
                if (progressBar) {
                    progressBar.style.width = progress + '%';
                }
                if (percentText) {
                    percentText.textContent = progress + '%';
                }
                if (statusText) {
                    statusText.textContent = `鈴?诪注讘讚... ${progress}%`;
                }
                
                if (progress % 25 === 0 && currentSubIndex < subtitleSimulation.length) {
                    const newLine = subtitleSimulation[currentSubIndex];
                    fullTranscript += (fullTranscript ? '\n' : '') + newLine;
                    transcriptText.textContent = fullTranscript;
                    currentSubIndex++;
                }
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    clearInterval(dotsInterval);
                    dotsEl.textContent = '';
                    
                    if (statusText) {
                        statusText.textContent = '鉁?转诪诇讜诇 讛讜砖诇诐!';
                        statusText.style.color = '#28a745';
                    }
                    
                    transcriptText.textContent = fullTranscript || '转诪诇讜诇 诪讚讜诪讛: ' + subtitleSimulation.join(' | ');
                    
                    const lastFile = uploadedFiles[uploadedFiles.length - 1];
                    if (lastFile) {
                        lastFile.transcription = fullTranscript || '转诪诇讜诇 诪讚讜诪讛';
                        updateFilesList();
                    }
                    
                    closeBtn.textContent = '鉁?住讙讜专 (讛讜砖诇诐)';
                    closeBtn.style.background = '#28a745';
                    
                    addMessage(`鉁?${file.name} - 转诪诇讜诇 讛讜砖诇诐!`, false);
                }
            }, 200);
            
            // 鉁?DOWNLOAD BUTTONS
            downloadTXTBtn.addEventListener('click', () => {
                const text = transcriptText.textContent;
                if (!text || text === '诪诪转讬谉...') {
                    alert('讗讬谉 转诪诇讜诇 注讚讬讬谉');
                    return;
                }
                
                const content = `讞讬-讗诪转 - 转诪诇讜诇 讜讬讚讗讜\n${'='.repeat(50)}\n拽讜讘抓: ${file.name}\n转讗专讬讱: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n\n${text}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `video_transcription_${file.name.replace(/\.[^/.]+$/, '')}.txt`;
                link.click();
                URL.revokeObjectURL(link.href);
                addMessage(`馃搫 讛讜专讚: ${link.download}`, false);
            });
            
            downloadDOCXBtn.addEventListener('click', () => {
                const text = transcriptText.textContent;
                if (!text || text === '诪诪转讬谉...') {
                    alert('讗讬谉 转诪诇讜诇 注讚讬讬谉');
                    return;
                }
                
                const doc = new docx.Document({
                    sections: [{
                        children: [
                            new docx.Paragraph({
                                text: '馃幀 讞讬-讗诪转 - 转诪诇讜诇 讜讬讚讗讜',
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: `拽讜讘抓: ${file.name}`,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: `转讗专讬讱: ${new Date().toLocaleString('he-IL')}`,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: text,
                                spacing: { after: 200 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `video_transcription_${file.name.replace(/\.[^/.]+$/, '')}.docx`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    addMessage(`馃搵 讛讜专讚: ${link.download}`, false);
                });
            });
            
            // 鉁?CLOSE BUTTON
            closeBtn.addEventListener('click', () => {
                clearInterval(progressInterval);
                clearInterval(dotsInterval);
                
                const finalTranscript = transcriptText.textContent;
                
                // 鉁?CREATE PANEL VERSION
                const videoContainer = document.getElementById('videoContainer');
                if (videoContainer) {
                    videoContainer.style.display = 'block';
                    
                    const panelHTML = `
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-top: 12px;">
                            <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃帴 谞讙谉 讜讬讚讗讜</div>
                            <video controls style="width: 100%; max-height: 300px; margin-bottom: 12px; border-radius: 8px; background: #000;">
                                <source src="${videoURL}" type="${file.type}">
                            </video>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-bottom: 12px; max-height: 150px; overflow-y: auto; direction: rtl; text-align: right; line-height: 1.8;">
                                <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃摑 转诪诇讜诇:</div>
                                <div style="color: white;">${finalTranscript}</div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px;">
                                <button onclick="downloadVideoTranscription(${timestamp}, 'txt', '${file.name.replace(/'/g, "\\'")}', \`${finalTranscript.replace(/`/g, '\\`')}\`)" style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    馃搫 讛讜专讚 TXT
                                </button>
                                <button onclick="downloadVideoTranscription(${timestamp}, 'docx', '${file.name.replace(/'/g, "\\'")}', \`${finalTranscript.replace(/`/g, '\\`')}\`)" style="background: #17a2b8; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                    馃搵 讛讜专讚 DOCX
                                </button>
                            </div>
                            
                            <button onclick="reopenVideoPopup(${timestamp}, '${file.name.replace(/'/g, "\\'")}', '${file.type}', '${videoURL}', \`${finalTranscript.replace(/`/g, '\\`')}\`)" style="background: #667eea; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%;">
                                馃攧 驻转讞 讞诇讜谉 转诪诇讜诇 砖讜讘
                            </button>
                        </div>
                    `;
                    
                    const existingPanel = document.getElementById(`videoPanel_${timestamp}`);
                    if (existingPanel) {
                        existingPanel.remove();
                    }
                    
                    const panelDiv = document.createElement('div');
                    panelDiv.id = `videoPanel_${timestamp}`;
                    panelDiv.innerHTML = panelHTML;
                    videoContainer.appendChild(panelDiv);
                }
                
                document.body.removeChild(popup);
                
                addMessage(`鉁?${file.name} - 讞诇讜谉 谞住讙专, 讛转讜讻谉 讘驻讗谞诇`, false);
                
                const fileInput = document.getElementById('videoInput');
                if (fileInput) fileInput.value = '';
            });
            
            // 鉁?REAL-TIME SUBTITLES DURING PLAYBACK
            popupVideo.addEventListener('timeupdate', function() {
                const currentTime = this.currentTime;
                const duration = this.duration;
                
                if (duration > 0 && progress >= 100) {
                    if (currentTime < duration * 0.25) {
                        transcriptText.textContent = '馃摵 ' + subtitleSimulation[0];
                    } else if (currentTime < duration * 0.5) {
                        transcriptText.textContent = '馃摵 ' + subtitleSimulation[1];
                    } else if (currentTime < duration * 0.75) {
                        transcriptText.textContent = '馃摵 ' + subtitleSimulation[2];
                    } else {
                        transcriptText.textContent = '馃摵 ' + subtitleSimulation[3];
                    }
                }
            });
        }

        
        function downloadVideoTranscription(timestamp, format, filename, text) {
            if (!text || text === '诪诪转讬谉...') {
                alert('讗讬谉 转诪诇讜诇 讝诪讬谉');
                return;
            }
            
            if (format === 'txt') {
                const content = `讞讬-讗诪转 - 转诪诇讜诇 讜讬讚讗讜\n${'='.repeat(50)}\n拽讜讘抓: ${filename}\n转讗专讬讱: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n\n${text}`;
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `video_transcription_${filename.replace(/\.[^/.]+$/, '')}.txt`;
                link.click();
                URL.revokeObjectURL(link.href);
                addMessage(`馃搫 讛讜专讚: ${link.download}`, false);
            } else if (format === 'docx') {
                const doc = new docx.Document({
                    sections: [{
                        children: [
                            new docx.Paragraph({
                                text: '馃幀 讞讬-讗诪转 - 转诪诇讜诇 讜讬讚讗讜',
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: `拽讜讘抓: ${filename}`,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: `转讗专讬讱: ${new Date().toLocaleString('he-IL')}`,
                                spacing: { after: 400 }
                            }),
                            new docx.Paragraph({
                                text: text,
                                spacing: { after: 200 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `video_transcription_${filename.replace(/\.[^/.]+$/, '')}.docx`;
                    link.click();
                    URL.revokeObjectURL(link.href);
                    addMessage(`馃搵 讛讜专讚: ${link.download}`, false);
                });
            }
        }
        
        function reopenVideoPopup(timestamp, filename, filetype, videoURL, savedTranscript) {
            // Remove existing panel
            const existingPanel = document.getElementById(`videoPanel_${timestamp}`);
            if (existingPanel) {
                existingPanel.remove();
            }
            
            // Create popup again
            const popup = document.createElement('div');
            popup.id = `videoPopup_${timestamp}_reopen`;
            popup.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 25px;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.5);
                z-index: 10000;
                max-width: 90vw;
                max-height: 90vh;
                overflow-y: auto;
                color: white;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            `;
            
            popup.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; font-size: 24px;">馃幀 转诪诇讜诇 讜讬讚讗讜</h2>
                    <div style="font-size: 14px; opacity: 0.8;">${filename}</div>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-weight: bold; margin-bottom: 10px; color: #FFD700;">馃帴 谞讙谉 讜讬讚讗讜</div>
                    <video controls style="width: 100%; max-height: 400px; border-radius: 8px; background: #000;">
                        <source src="${videoURL}" type="${filetype}">
                    </video>
                </div>
                
                <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; margin-bottom: 15px; max-height: 150px; overflow-y: auto; direction: rtl; text-align: right; line-height: 1.8;">
                    <div style="font-weight: bold; margin-bottom: 6px; color: #FFD700;">馃摑 转诪诇讜诇:</div>
                    <div style="color: white;">${savedTranscript}</div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <button onclick="downloadVideoTranscription(${timestamp}, 'txt', '${filename.replace(/'/g, "\\'")}', \`${savedTranscript.replace(/`/g, '\\`')}\`)" style="background: #28a745; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搫 讛讜专讚 TXT
                    </button>
                    <button onclick="downloadVideoTranscription(${timestamp}, 'docx', '${filename.replace(/'/g, "\\'")}', \`${savedTranscript.replace(/`/g, '\\`')}\`)" style="background: #17a2b8; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                        馃搵 讛讜专讚 DOCX
                    </button>
                </div>
                
                <button onclick="this.parentElement.parentElement.remove(); document.getElementById('videoPanel_${timestamp}').style.display = 'block';" style="width: 100%; background: #dc3545; color: white; border: none; padding: 14px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">
                    鉁?住讙讜专
                </button>
            `;
            
            document.body.appendChild(popup);
            addMessage(`馃攧 ${filename} - 讞诇讜谉 谞驻转讞 诪讞讚砖`, false);
        }
        
        function handleTxtUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n').filter(l => l.trim());
                
                const fileData = {
                    name: file.name,
                    time: getPrecisionTime(),
                    type: 'txt',
                    size: (file.size / 1024).toFixed(2) + ' KB',
                    transcription: lines.slice(0, 3).join('\n...')
                };
                
                uploadedFiles.push(fileData);
                updateFilesList();
                addMessage(`馃搫 讛讜注诇讛: ${file.name} (${lines.length} 砖讜专讜转)`, false);
            };
            reader.readAsText(file);
        }

        function handleDocxUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const fileData = {
                name: file.name,
                time: getPrecisionTime(),
                type: 'docx',
                size: (file.size / 1024).toFixed(2) + ' KB',
                transcription: '鈴?诪注讘讚转 DOCX...'
            };
            
            uploadedFiles.push(fileData);
            updateFilesList();
            addMessage(`馃搵 讛注诇讗讛: ${file.name}`, false);
        }

        function updateFilesList() {
            const filesList = document.getElementById('filesList');
            
            if (uploadedFiles.length === 0) {
                filesList.innerHTML = '<div class="empty-files">讗讬谉 拽讘爪讬诐 注讚讬讬谉</div>';
                return;
            }
            
            filesList.innerHTML = '';
            uploadedFiles.forEach((file) => {
                const fileEl = document.createElement('div');
                fileEl.className = 'file-item';
                
                let icon = '馃搫';
                if (file.type === 'txt') icon = '馃搫';
                if (file.type === 'docx') icon = '馃搵';
                if (file.type === 'audio') icon = '馃幍';
                if (file.type === 'video') icon = '馃幀';
                
                let details = `${file.time}s`;
                if (file.size) details += ` | ${file.size}`;
                
                let html = `
                    <div class="file-name">${icon} ${file.name}</div>
                    <div style="font-size: 0.7em; color: #999;">${details}</div>
                `;
                
                if (file.transcription) {
                    html += `<div class="file-transcription">${file.transcription}</div>`;
                }
                
                fileEl.innerHTML = html;
                filesList.appendChild(fileEl);
            });
        }

        function clearAllFiles() {
            if (confirm('讘讟讜讞?')) {
                uploadedFiles = [];
                transcriptionHistory = [];
                updateFilesList();
                safeSetText('finalTranscript', '');
                safeSetText('translatedText', '');
            }
        }

        function toggleStreamAccordion(element) {
            const accordion = document.getElementById('streamAccordion');
            const arrow = element.textContent.includes('鈻?) ? '鈻? : '鈻?;
            element.textContent = element.textContent.replace(/[鈻垛柤]/, arrow) + ' 讜讬讚讗讜 / 砖讚讜专 讞讬';
            accordion.style.display = accordion.style.display === 'none' ? 'block' : 'none';
        }

        function showYouTubeInput() {
            document.getElementById('youtubeInputArea').style.display = 'block';
            document.getElementById('liveStreamInputArea').style.display = 'none';
        }

        function showLiveStreamInput() {
            document.getElementById('youtubeInputArea').style.display = 'none';
            document.getElementById('liveStreamInputArea').style.display = 'block';
        }

        async function loadYouTubeVideo() {
            const url = document.getElementById('youtubeURL').value.trim();
            if (!url) {
                alert('讛讻谞住 YouTube URL');
                return;
            }
            
            let videoId = '';
            if (url.includes('youtu.be/')) {
                videoId = url.split('youtu.be/')[1].split('?')[0];
            } else if (url.includes('v=')) {
                videoId = url.split('v=')[1].split('&')[0];
            }
            
            if (videoId) {
                document.getElementById('videoContainer').style.display = 'block';
                const videoPlayerWrapper = document.getElementById('videoPlayerWrapper');
                videoPlayerWrapper.innerHTML = '';
                
                const container = document.createElement('div');
                container.style.marginBottom = '15px';
                
                const iframe = document.createElement('iframe');
                iframe.width = '100%';
                iframe.height = '480';
                iframe.src = `https://www.youtube.com/embed/    ${videoId}?enablejsapi=1`;
                iframe.title = 'YouTube video player';
                iframe.frameBorder = '0';
                iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
                iframe.allowFullscreen = true;
                iframe.style.borderRadius = '8px';
                container.appendChild(iframe);
                
                const controlsDiv = document.createElement('div');
                controlsDiv.style.cssText = 'margin-top: 12px; padding: 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px;';
                controlsDiv.innerHTML = `
                    <button onclick="fetchYouTubeCaptions('${videoId}')" style="background: #667eea; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; margin-right: 8px;">
                        馃摜 讛讜专讚 讻转讜讘讬讜转
                    </button>
                    <button onclick="captureYouTubeAudio('${videoId}')" style="background: #FF0000; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">
                        馃帳 讛拽诇讟 讗讜讚讬讜 诪讛住专讟讜谉
                    </button>
                    <div id="ytTranscript_${videoId}" style="margin-top: 12px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; color: white; display: none; direction: rtl; text-align: right;"></div>
                `;
                container.appendChild(controlsDiv);
                
                videoPlayerWrapper.appendChild(container);
                
                addMessage(`馃摵 YouTube: ${url.substring(0, 50)}...`, false);
                addMessage(`馃挕 诇讞抓 "馃摜 讛讜专讚 讻转讜讘讬讜转" 讗诐 讛住专讟讜谉 讻讜诇诇 讻转讜讘讬讜转, 讗讜 "馃帳 讛拽诇讟 讗讜讚讬讜" 诇讛拽诇讟讛 讬讚谞讬转`, false);
            }
        }

        async function fetchYouTubeCaptions(videoId) {
            try {
                addMessage('馃攳 诪讞驻砖 讻转讜讘讬讜转...', false);
                
                const languages = ['he', 'iw', 'en', 'auto'];
                let captionsFound = false;
                
                for (const lang of languages) {
                    try {
                        const captionsUrl = `https://www.youtube.com/api/timedtext?v=    ${videoId}&lang=${lang}`;
                        const response = await fetch(captionsUrl, { mode: 'cors' });
                        
                        if (response.ok) {
                            const xmlText = await response.text();
                            
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                            const textNodes = xmlDoc.getElementsByTagName('text');
                            
                            let fullText = '';
                            for (let i = 0; i < textNodes.length; i++) {
                                fullText += textNodes[i].textContent + ' ';
                            }
                            
                            if (fullText.trim()) {
                                captionsFound = true;
                                
                                // 鉁?FIX 3: ALWAYS UPDATE MAIN VIDEO TRANSCRIPT!
                                const mainVideoTranscript = document.getElementById('videoTranscript');
                                if (mainVideoTranscript) {
                                    safeSetText('videoTranscript', fullText.trim());
                                }
                                
                                // 鉁?Also update live translation panel
                                const liveTranslation = document.getElementById('liveVideoTranslation');
                                if (liveTranslation) {
                                    liveTranslation.textContent = fullText.trim();
                                }
                                
                                // Local backup display
                                const transcriptDiv = document.getElementById(`ytTranscript_${videoId}`);
                                if (transcriptDiv) {
                                    transcriptDiv.style.display = 'block';
                                    transcriptDiv.innerHTML = `<strong>馃摑 讻转讜讘讬讜转 (${lang}):</strong><br>${fullText.trim()}`;
                                }
                                
                                // Save to history
                                videoTranscriptHistory.push({
                                    text: fullText.trim(),
                                    time: getExactTime(),
                                    source: 'youtube',
                                    videoId: videoId,
                                    language: lang
                                });
                                
                                // Save for download
                                window[`ytCaptions_${videoId}`] = {
                                    text: fullText.trim(),
                                    videoId: videoId,
                                    language: lang
                                };
                                
                                addMessage(`鉁?讻转讜讘讬讜转 谞诪爪讗讜 讜诪讜爪讙讜转! (${lang})`, false);
                                
                                // Add download buttons
                                const controlsDiv = transcriptDiv ? transcriptDiv.parentElement : null;
                                if (controlsDiv && !document.getElementById(`ytDownloadBtns_${videoId}`)) {
                                    const downloadDiv = document.createElement('div');
                                    downloadDiv.id = `ytDownloadBtns_${videoId}`;
                                    downloadDiv.style.cssText = 'margin-top: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;';
                                    downloadDiv.innerHTML = `
                                        <button onclick="downloadYouTubeCaptions('${videoId}', 'txt')" style="background: #28a745; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                            馃搫 讛讜专讚 TXT
                                        </button>
                                        <button onclick="downloadYouTubeCaptions('${videoId}', 'docx')" style="background: #17a2b8; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer;">
                                            馃搵 讛讜专讚 DOCX
                                        </button>
                                    `;
                                    controlsDiv.appendChild(downloadDiv);
                                }
                                
                                break;
                            }
                        }
                    } catch (e) {
                        console.log(`No captions for lang: ${lang}`);
                    }
                }
                
                if (!captionsFound) {
                    addMessage('鈿狅笍 诇讗 谞诪爪讗讜 讻转讜讘讬讜转. 谞住讛 "馃帳 讛拽诇讟 讗讜讚讬讜" 讘诪拽讜诐.', false);
                }
                
            } catch (error) {
                console.error('YouTube captions error:', error);
                addMessage(`鉂?砖讙讬讗讛 讘讛讜专讚转 讻转讜讘讬讜转: ${error.message}`, false);
            }
        }

        function downloadYouTubeCaptions(videoId, format) {
            const data = window[`ytCaptions_${videoId}`];
            if (!data || !data.text) {
                alert('讗讬谉 转诪诇讜诇 讝诪讬谉 诇讛讜专讚讛');
                return;
            }
            
            const filename = `youtube_${videoId}_captions`;
            
            if (format === 'txt') {
                const blob = new Blob([data.text], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename + '.txt';
                a.click();
                URL.revokeObjectURL(url);
            } else if (format === 'docx') {
                if (typeof docx === 'undefined') {
                    alert('docx.js 诇讗 讟注讜谉');
                    return;
                }
                
                const doc = new docx.Document({
                    sections: [{
                        properties: {},
                        children: [
                            new docx.Paragraph({
                                text: `YouTube Video: ${videoId}`,
                                heading: docx.HeadingLevel.HEADING_1,
                                spacing: { after: 200 }
                            }),
                            new docx.Paragraph({
                                text: data.text,
                                spacing: { line: 360 }
                            })
                        ]
                    }]
                });
                
                docx.Packer.toBlob(doc).then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename + '.docx';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
        }

        async function translateText(text, targetLang) {
            try {
                const response = await fetch(`https://api.mymemory.translated.net/get?q=    ${encodeURIComponent(text)}&langpair=${getLangCode(currentVoiceLang)}|${targetLang}`);
                const data = await response.json();
                
                if (data.responseStatus === 200) {
                    const translated = data.responseData.translatedText;
                    safeSetText('translatedText', translated);
                    return translated; // 鉁?Return for popup use
                }
                return text; // Return original if translation fails
            } catch (e) {
                console.log('Translation unavailable');
                return text; // Return original on error
            }
        }

        function getLangCode(fullLang) {
            const codes = {
                'he-IL': 'he', 'en-US': 'en', 'es-ES': 'es', 'fr-FR': 'fr',
                'de-DE': 'de', 'it-IT': 'it', 'pt-PT': 'pt', 'ru-RU': 'ru',
                'ar-SA': 'ar', 'ja-JP': 'ja', 'zh-CN': 'zh', 'ko-KR': 'ko',
                'hi-IN': 'hi', 'nl-NL': 'nl', 'pl-PL': 'pl'
            };
            return codes[fullLang] || 'en';
        }

        function changeTranslateLanguage() {
            selectedTranslateLang = document.getElementById('translateLang').value;
            const translatedBox = document.getElementById('translatedBox');
            
            if (selectedTranslateLang) {
                translatedBox.style.display = 'block';
                const currentText = document.getElementById('finalTranscript').textContent.trim();
                if (currentText) {
                    translateText(currentText, selectedTranslateLang);
                }
            } else {
                translatedBox.style.display = 'none';
                safeSetText('translatedText', '');
            }
        }

        function addMessage(text, isUser = false) {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${isUser ? 'user' : 'assistant'}`;
            
            const wrapper = document.createElement('div');
            wrapper.className = 'message-wrapper';
            
            const contentEl = document.createElement('div');
            contentEl.className = 'message-content';
            contentEl.textContent = text;
            
            const timeEl = document.createElement('div');
            timeEl.className = 'message-time';
            timeEl.textContent = getExactTime();
            
            wrapper.appendChild(contentEl);
            wrapper.appendChild(timeEl);
            messageEl.appendChild(wrapper);
            document.getElementById('chatArea').appendChild(messageEl);
            
            document.getElementById('chatArea').scrollTop = document.getElementById('chatArea').scrollHeight;
        }

        async function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) return;
            
            addMessage(message, true);
            const msgInput = document.getElementById('messageInput');
            if (msgInput) msgInput.value = '';
            updateStatus('鈴?诪砖讚专转 转讙讜讘讛...');
            
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'chat',
                        message: message,
                        token: TOKEN,
                        language: currentVoiceLang,
                        userId: userId,
                        timestamp: getPrecisionTime()
                    })
                });
                
                const data = await response.json();
                
                if (data.reply) {
                    addMessage(data.reply, false);
                }
                
                updateStatus('鉁?讘讞讝专讛 诪讛诇讬讘讛');
                
                transcriptionHistory.push({
                    text: message,
                    reply: data.reply,
                    time: getPrecisionTime(),
                    lang: currentVoiceLang,
                    learned: data.learned
                });
                
            } catch (error) {
                addMessage('鉂?砖讙讬讗讛 讘讞讬讘讜专 诇诇讬讘讛.', false);
                updateStatus('鉂?砖讙讬讗讛');
            }
        }

        function saveTranscriptionTXT() {
            if (transcriptionHistory.length === 0) {
                alert('讗讬谉 讟拽住讟 诇砖诪讜专');
                return;
            }
            
            const content = transcriptionHistory.map((t, i) => 
                `${i + 1}. [${t.time}s] ${t.text}`
            ).join('\n');
            
            const header = `讞讬-讗诪转 Transcription\n`;
            const metadata = `砖驻讛: ${LANGUAGES_CONFIG[currentVoiceLang]?.name || 'Unknown'}\n讝诪谉: ${new Date().toLocaleString('he-IL')}\n${'='.repeat(50)}\n`;
            const fullContent = header + metadata + content;
            
            const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const filename = `transcription_${Date.now()}.txt`;
            link.download = filename;
            link.click();
            
            uploadedFiles.push({
                name: filename,
                time: getPrecisionTime(),
                type: 'txt',
                size: (blob.size / 1024).toFixed(2) + ' KB'
            });
            updateFilesList();
            addMessage(`馃搫 砖诪讜专: ${filename}`, false);
        }

        function saveTranscriptionDOCX() {
            if (transcriptionHistory.length === 0) {
                alert('讗讬谉 讟拽住讟 诇砖诪讜专');
                return;
            }
            
            const sections = transcriptionHistory.map((t, i) => {
                const isEven = i % 2 === 0;
                return new docx.Paragraph({
                    children: [
                        new docx.TextRun({
                            text: `${i + 1}. `,
                            bold: true,
                            color: "667eea",
                            size: 24
                        }),
                        new docx.TextRun({
                            text: `[${t.time}] `,
                            italics: true,
                            color: "999999",
                            size: 20
                        }),
                        new docx.TextRun({
                            text: t.text,
                            size: 22,
                            font: "Arial"
                        })
                    ],
                    spacing: { 
                        line: 360,
                        before: 120,
                        after: 120
                    },
                    shading: {
                        fill: isEven ? "f8f9fa" : "ffffff",
                        type: docx.ShadingType.CLEAR
                    },
                    border: {
                        bottom: {
                            color: "e0e0e0",
                            space: 1,
                            style: docx.BorderStyle.SINGLE,
                            size: 6
                        }
                    }
                });
            });
            
            const doc = new docx.Document({
                sections: [{
                    properties: {
                        page: {
                            margin: {
                                top: 1440,
                                right: 1440,
                                bottom: 1440,
                                left: 1440
                            }
                        }
                    },
                    children: [
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: "馃挍 讞讬-讗诪转",
                                    bold: true,
                                    size: 48,
                                    color: "ffd700"
                                }),
                                new docx.TextRun({
                                    text: " - 转诪诇讜诇 拽讜诇讬",
                                    bold: true,
                                    size: 36,
                                    color: "667eea"
                                })
                            ],
                            heading: docx.HeadingLevel.HEADING_1,
                            spacing: { after: 400 },
                            alignment: docx.AlignmentType.CENTER,
                            border: {
                                bottom: {
                                    color: "667eea",
                                    space: 1,
                                    style: docx.BorderStyle.DOUBLE,
                                    size: 24
                                }
                            }
                        }),
                        
                        new docx.Table({
                            width: {
                                size: 100,
                                type: docx.WidthType.PERCENTAGE
                            },
                            borders: {
                                top: { style: docx.BorderStyle.SINGLE, size: 1, color: "667eea" },
                                bottom: { style: docx.BorderStyle.SINGLE, size: 1, color: "667eea" },
                                left: { style: docx.BorderStyle.SINGLE, size: 1, color: "667eea" },
                                right: { style: docx.BorderStyle.SINGLE, size: 1, color: "667eea" }
                            },
                            rows: [
                                new docx.TableRow({
                                    children: [
                                        new docx.TableCell({
                                            children: [new docx.Paragraph({ text: "馃實 砖驻讛:", bold: true })],
                                            shading: { fill: "667eea", color: "ffffff" }
                                        }),
                                        new docx.TableCell({
                                            children: [new docx.Paragraph(LANGUAGES_CONFIG[currentVoiceLang]?.name || 'Unknown')]
                                        })
                                    ]
                                }),
                                new docx.TableRow({
                                    children: [
                                        new docx.TableCell({
                                            children: [new docx.Paragraph({ text: "馃晲 讝诪谉:", bold: true })],
                                            shading: { fill: "667eea", color: "ffffff" }
                                        }),
                                        new docx.TableCell({
                                            children: [new docx.Paragraph(new Date().toLocaleString('he-IL'))]
                                        })
                                    ]
                                }),
                                new docx.TableRow({
                                    children: [
                                        new docx.TableCell({
                                            children: [new docx.Paragraph({ text: "馃摑 诪砖驻讟讬诐:", bold: true })],
                                            shading: { fill: "667eea", color: "ffffff" }
                                        }),
                                        new docx.TableCell({
                                            children: [new docx.Paragraph(transcriptionHistory.length.toString())]
                                        })
                                    ]
                                })
                            ]
                        }),
                        
                        new docx.Paragraph({ text: "", spacing: { after: 400 } }),
                        
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: "馃搫 转诪诇讜诇 诪诇讗",
                                    bold: true,
                                    size: 32,
                                    color: "667eea"
                                })
                            ],
                            heading: docx.HeadingLevel.HEADING_2,
                            spacing: { after: 300 }
                        }),
                        
                        ...sections,
                        
                        new docx.Paragraph({ text: "", spacing: { before: 400 } }),
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: "鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺愨晲鈺?,
                                    color: "999999"
                                })
                            ],
                            alignment: docx.AlignmentType.CENTER
                        }),
                        new docx.Paragraph({
                            children: [
                                new docx.TextRun({
                                    text: "馃敀 TNTF | Binary: 0101-0101(0101) | 讞讬-讗诪转 馃挍",
                                    italics: true,
                                    size: 18,
                                    color: "667eea"
                                })
                            ],
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { before: 200 }
                        })
                    ]
                }]
            });
            
            docx.Packer.toBlob(doc).then(blob => {
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const filename = `讞讬-讗诪转_转诪诇讜诇_${Date.now()}.docx`;
                link.download = filename;
                link.click();
                
                uploadedFiles.push({
                    name: filename,
                    time: getPrecisionTime(),
                    type: 'docx',
                    size: (blob.size / 1024).toFixed(2) + ' KB'
                });
                updateFilesList();
                addMessage(`馃搵 砖诪讜专: ${filename}`, false);
            });
        }

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.target.id === 'messageInput') {
                e.preventDefault();
                sendMessage();
            }
        });

        console.log('鉁?Hai-Emet VOICE System Ready!');
        console.log('Binary: ' + BINARY_SIG);
    </script>
</body>
</html>
