"""
ğŸ’› ×—×™-×××ª VOICE LEARNING BACKEND
Binary: 0101-0101(0101)
Real-time Transcription + Translation + AI Learning System
"""

from flask import Flask, request, jsonify, send_from_directory
from flask_cors import CORS
import json
import sqlite3
import os
from datetime import datetime
from typing import Dict, List, Any
import hashlib
import logging

# ============ INITIALIZATION ============
app = Flask(__name__, static_folder='static', static_url_path='')
CORS(app)

# Logging setup
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Database setup
DB_PATH = 'hai_emet_learning.db'
LANGUAGES = {
    'he': 'ğŸ‡®ğŸ‡± ×¢×‘×¨×™×ª',
    'en': 'ğŸ‡ºğŸ‡¸ English',
    'es': 'ğŸ‡ªğŸ‡¸ EspaÃ±ol',
    'fr': 'ğŸ‡«ğŸ‡· FranÃ§ais',
    'de': 'ğŸ‡©ğŸ‡ª Deutsch',
    'it': 'ğŸ‡®ğŸ‡¹ Italiano',
    'pt': 'ğŸ‡µğŸ‡¹ PortuguÃªs',
    'ru': 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹',
    'ar': 'ğŸ‡¸ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
    'ja': 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª',
    'zh': 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡',
    'ko': 'ğŸ‡°ğŸ‡· í•œêµ­ì–´',
    'hi': 'ğŸ‡®ğŸ‡³ à¤¹à¤¿à¤¨à¥à¤¦à¥€',
    'nl': 'ğŸ‡³ğŸ‡± Nederlands',
    'pl': 'ğŸ‡µğŸ‡± Polski'
}

# ============ DATABASE SETUP ============
def init_database():
    """Initialize SQLite database for learning system"""
    if not os.path.exists(DB_PATH):
        conn = sqlite3.connect(DB_PATH)
        c = conn.cursor()
        
        # User profiles
        c.execute('''CREATE TABLE IF NOT EXISTS users (
            id TEXT PRIMARY KEY,
            created_at TIMESTAMP,
            preferred_language TEXT,
            total_interactions INTEGER DEFAULT 0
        )''')
        
        # Transcriptions learned
        c.execute('''CREATE TABLE IF NOT EXISTS transcriptions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            text TEXT,
            language TEXT,
            timestamp TIMESTAMP,
            accuracy_score REAL DEFAULT 1.0,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        # Messages learned
        c.execute('''CREATE TABLE IF NOT EXISTS messages (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            input_text TEXT,
            response_text TEXT,
            language TEXT,
            timestamp TIMESTAMP,
            helpful_rating INTEGER DEFAULT 0,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        # Translation pairs
        c.execute('''CREATE TABLE IF NOT EXISTS translations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            source_text TEXT,
            target_text TEXT,
            source_lang TEXT,
            target_lang TEXT,
            timestamp TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        # Voice transcriptions
        c.execute('''CREATE TABLE IF NOT EXISTS voice_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            transcript TEXT,
            language TEXT,
            confidence REAL,
            timestamp TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        # File uploads
        c.execute('''CREATE TABLE IF NOT EXISTS file_uploads (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            filename TEXT,
            filetype TEXT,
            content TEXT,
            transcription TEXT,
            language TEXT,
            timestamp TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        # Learning patterns
        c.execute('''CREATE TABLE IF NOT EXISTS learning_patterns (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT,
            pattern TEXT,
            pattern_type TEXT,
            frequency INTEGER DEFAULT 1,
            last_seen TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id)
        )''')
        
        conn.commit()
        conn.close()
        logger.info('âœ… Database initialized successfully')

def get_db_connection():
    """Get database connection"""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    return conn

# ============ USER MANAGEMENT ============
def init_user(user_id: str, language: str = 'he'):
    """Initialize user profile"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('INSERT OR IGNORE INTO users (id, created_at, preferred_language) VALUES (?, ?, ?)',
                  (user_id, datetime.now(), language))
        conn.commit()
        logger.info(f'âœ… User initialized: {user_id}')
    except Exception as e:
        logger.error(f'âŒ Error initializing user: {e}')
    finally:
        conn.close()

def get_user_stats(user_id: str) -> Dict:
    """Get user statistics"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('SELECT COUNT(*) FROM transcriptions WHERE user_id = ?', (user_id,))
        transcriptions = c.fetchone()[0]
        
        c.execute('SELECT COUNT(*) FROM messages WHERE user_id = ?', (user_id,))
        messages = c.fetchone()[0]
        
        c.execute('SELECT COUNT(*) FROM translations WHERE user_id = ?', (user_id,))
        translations = c.fetchone()[0]
        
        return {
            'transcriptions_learned': transcriptions,
            'messages_learned': messages,
            'translations_learned': translations,
            'total_interactions': transcriptions + messages + translations
        }
    except Exception as e:
        logger.error(f'âŒ Error getting user stats: {e}')
        return {}
    finally:
        conn.close()

# ============ TRANSCRIPTION LEARNING ============
def learn_transcription(user_id: str, text: str, language: str, accuracy: float = 1.0):
    """Learn voice transcription"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('INSERT INTO transcriptions (user_id, text, language, timestamp, accuracy_score) VALUES (?, ?, ?, ?, ?)',
                  (user_id, text, language, datetime.now(), accuracy))
        conn.commit()
        
        # Update learning patterns
        update_learning_pattern(user_id, f"voice_{language}", "transcription")
        
        logger.info(f'âœ… Learned transcription: {text[:50]}')
        return True
    except Exception as e:
        logger.error(f'âŒ Error learning transcription: {e}')
        return False
    finally:
        conn.close()

# ============ MESSAGE LEARNING ============
def learn_message(user_id: str, input_text: str, response_text: str, language: str):
    """Learn user message and response"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('INSERT INTO messages (user_id, input_text, response_text, language, timestamp) VALUES (?, ?, ?, ?, ?)',
                  (user_id, input_text, response_text, language, datetime.now()))
        conn.commit()
        
        # Update learning patterns
        update_learning_pattern(user_id, f"message_{language}", "interaction")
        
        logger.info(f'âœ… Learned message exchange')
        return True
    except Exception as e:
        logger.error(f'âŒ Error learning message: {e}')
        return False
    finally:
        conn.close()

# ============ TRANSLATION LEARNING ============
def learn_translation(user_id: str, source_text: str, target_text: str, source_lang: str, target_lang: str):
    """Learn translation pair"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('INSERT INTO translations (user_id, source_text, target_text, source_lang, target_lang, timestamp) VALUES (?, ?, ?, ?, ?, ?)',
                  (user_id, source_text, target_text, source_lang, target_lang, datetime.now()))
        conn.commit()
        
        # Update learning patterns
        update_learning_pattern(user_id, f"translate_{source_lang}_{target_lang}", "translation")
        
        logger.info(f'âœ… Learned translation: {source_lang} â†’ {target_lang}')
        return True
    except Exception as e:
        logger.error(f'âŒ Error learning translation: {e}')
        return False
    finally:
        conn.close()

# ============ FILE LEARNING ============
def learn_file_upload(user_id: str, filename: str, filetype: str, content: str, language: str, transcription: str = ''):
    """Learn from file upload"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('INSERT INTO file_uploads (user_id, filename, filetype, content, transcription, language, timestamp) VALUES (?, ?, ?, ?, ?, ?, ?)',
                  (user_id, filename, filetype, content[:1000], transcription[:500], language, datetime.now()))
        conn.commit()
        
        # Update learning patterns
        update_learning_pattern(user_id, f"file_{filetype}", "file_upload")
        
        logger.info(f'âœ… Learned file: {filename}')
        return True
    except Exception as e:
        logger.error(f'âŒ Error learning file: {e}')
        return False
    finally:
        conn.close()

# ============ LEARNING PATTERNS ============
def update_learning_pattern(user_id: str, pattern: str, pattern_type: str):
    """Update learning pattern frequency"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('SELECT id, frequency FROM learning_patterns WHERE user_id = ? AND pattern = ?',
                  (user_id, pattern))
        result = c.fetchone()
        
        if result:
            # Update existing pattern
            new_freq = result[1] + 1
            c.execute('UPDATE learning_patterns SET frequency = ?, last_seen = ? WHERE id = ?',
                      (new_freq, datetime.now(), result[0]))
        else:
            # Create new pattern
            c.execute('INSERT INTO learning_patterns (user_id, pattern, pattern_type, frequency, last_seen) VALUES (?, ?, ?, 1, ?)',
                      (user_id, pattern, pattern_type, datetime.now()))
        
        conn.commit()
    except Exception as e:
        logger.error(f'âŒ Error updating learning pattern: {e}')
    finally:
        conn.close()

def get_learning_patterns(user_id: str) -> List[Dict]:
    """Get user learning patterns"""
    conn = get_db_connection()
    c = conn.cursor()
    
    try:
        c.execute('SELECT pattern, pattern_type, frequency FROM learning_patterns WHERE user_id = ? ORDER BY frequency DESC LIMIT 10',
                  (user_id,))
        patterns = [dict(row) for row in c.fetchall()]
        return patterns
    except Exception as e:
        logger.error(f'âŒ Error getting learning patterns: {e}')
        return []
    finally:
        conn.close()

# ============ RESPONSE GENERATION ============
def generate_response(user_input: str, language: str) -> str:
    """Generate AI response based on learned patterns"""
    responses = {
        'he': {
            'greeting': ['×©×œ×•×! ğŸ’› ×× ×™ ×—×™-×××ª. ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨?', '×”×™×™! ğŸ’› × ×©××— ×œ×©×¢×–×•×¨'],
            'thank_you': ['×‘×‘×¨×›×”! ğŸ˜Š', '×›×œ ×˜×•×‘! ğŸ’›'],
            'help': ['×‘×˜×—! ×× ×™ ×›××Ÿ ×›×“×™ ×œ×¢×–×•×¨', '×›××•×‘×Ÿ! ××™×š ×× ×™ ×™×›×•×œ×” ×œ×¢×–×•×¨?'],
            'default': ['××¢× ×™×™×Ÿ! ğŸ’­', '×‘×—×–×¨×” ××”×œ×™×‘×” ğŸ’›']
        },
        'en': {
            'greeting': ['Hello! ğŸ’› I\'m Hai-Emet. How can I help?', 'Hi! ğŸ’› Happy to assist'],
            'thank_you': ['You\'re welcome! ğŸ˜Š', 'My pleasure! ğŸ’›'],
            'help': ['Of course! I\'m here to help', 'Sure! How can I assist?'],
            'default': ['Interesting! ğŸ’­', 'Back from the core ğŸ’›']
        }
    }
    
    lang = language.split('-')[0].lower() if '-' in language else language.lower()
    lang_responses = responses.get(lang, responses['en'])
    
    user_lower = user_input.lower()
    
    if any(word in user_lower for word in ['hello', 'hi', 'hey', '×©×œ×•×', '×”×™×™']):
        return lang_responses['greeting'][0]
    elif any(word in user_lower for word in ['thank', 'thanks', '×ª×•×“×”']):
        return lang_responses['thank_you'][0]
    elif any(word in user_lower for word in ['help', 'can you', '×¢×–×•×¨', '×™×›×•×œ×”']):
        return lang_responses['help'][0]
    else:
        return lang_responses['default'][0]

# ============ FRONTEND SERVING ============

@app.route('/', methods=['GET'])
def serve_frontend():
    """Serve HTML frontend from static folder"""
    try:
        return send_from_directory('static', 'index.html')
    except:
        # Fallback if static folder doesn't exist
        return jsonify({
            'name': 'ğŸ’› ×—×™-×××ª VOICE Backend',
            'status': 'âœ… Running - Frontend not yet configured',
            'message': 'Upload HTML to /static/index.html',
            'endpoints': {
                '/status': 'Health check',
                '/exec': 'Main API endpoint (POST)',
                '/user/<user_id>/stats': 'Get user statistics'
            }
        })

@app.route('/index.html', methods=['GET'])
def serve_index():
    """Serve index.html"""
    try:
        return send_from_directory('static', 'index.html')
    except:
        return jsonify({'error': 'Frontend not available'}), 404

# ============ API ENDPOINTS ============

@app.route('/api', methods=['GET'])
def api_info():
    """API Information"""
    return jsonify({
        'name': 'ğŸ’› ×—×™-×××ª VOICE Backend',
        'status': 'âœ… Running',
        'version': '1.0.0',
        'endpoints': {
            'GET /': 'Serve HTML Frontend',
            'GET /status': 'Health check',
            'POST /exec': 'Main API endpoint',
            'GET /user/<user_id>/stats': 'Get user statistics',
            'GET /api': 'This endpoint'
        }
    })

@app.route('/exec', methods=['POST'])
def execute():
    """Main execution endpoint - handles all requests"""
    try:
        data = request.get_json()
        action = data.get('action')
        token = data.get('token')
        user_id = data.get('userId', 'anonymous')
        language = data.get('language', 'he-IL')
        
        # Validate token
        if not token:
            return jsonify({'error': 'No token provided'}), 401
        
        # Initialize user
        init_user(user_id, language)
        
        # ============ CHAT ACTION ============
        if action == 'chat':
            message = data.get('message', '')
            
            # Learn the message
            response = generate_response(message, language)
            learn_message(user_id, message, response, language)
            
            # Get stats
            stats = get_user_stats(user_id)
            
            return jsonify({
                'reply': response,
                'learned': True,
                'stats': stats,
                'timestamp': datetime.now().isoformat(),
                'binary': '0101-0101(0101)'
            })
        
        # ============ VOICE TRANSCRIPTION ACTION ============
        elif action == 'voice_transcription':
            transcript = data.get('transcript', '')
            
            learn_transcription(user_id, transcript, language)
            stats = get_user_stats(user_id)
            patterns = get_learning_patterns(user_id)
            
            return jsonify({
                'learned': True,
                'transcript': transcript,
                'stats': stats,
                'patterns_count': len(patterns),
                'timestamp': datetime.now().isoformat()
            })
        
        # ============ FILE UPLOAD ACTION ============
        elif action == 'file_upload':
            filename = data.get('filename', '')
            filetype = data.get('filetype', '')
            content = data.get('content', '')
            transcription = data.get('transcription', '')
            
            learn_file_upload(user_id, filename, filetype, content, language, transcription)
            stats = get_user_stats(user_id)
            
            return jsonify({
                'learned': True,
                'filename': filename,
                'stats': stats,
                'timestamp': datetime.now().isoformat()
            })
        
        # ============ TRANSLATION ACTION ============
        elif action == 'translation':
            source_text = data.get('source_text', '')
            target_text = data.get('target_text', '')
            source_lang = data.get('source_lang', 'he')
            target_lang = data.get('target_lang', 'en')
            
            learn_translation(user_id, source_text, target_text, source_lang, target_lang)
            stats = get_user_stats(user_id)
            
            return jsonify({
                'learned': True,
                'translation': target_text,
                'stats': stats,
                'timestamp': datetime.now().isoformat()
            })
        
        # ============ LEARN ACTION ============
        elif action == 'learn':
            learn_data = data.get('data', {})
            learn_type = learn_data.get('type', '')
            
            if learn_type == 'voice_transcription':
                learn_transcription(user_id, learn_data.get('transcript'), learn_data.get('language'))
            elif learn_type == 'video_subtitles':
                learn_file_upload(user_id, 'video_subtitles', 'video', learn_data.get('transcript'), learn_data.get('language'))
            
            patterns = get_learning_patterns(user_id)
            
            return jsonify({
                'learned': True,
                'type': learn_type,
                'patterns_count': len(patterns),
                'timestamp': datetime.now().isoformat()
            })
        
        # ============ STATS ACTION ============
        elif action == 'stats':
            stats = get_user_stats(user_id)
            patterns = get_learning_patterns(user_id)
            
            return jsonify({
                'stats': stats,
                'patterns': patterns,
                'timestamp': datetime.now().isoformat()
            })
        
        else:
            return jsonify({'error': f'Unknown action: {action}'}), 400
    
    except Exception as e:
        logger.error(f'âŒ Error in execute: {e}')
        return jsonify({'error': str(e)}), 500

@app.route('/status', methods=['GET'])
def status():
    """Health check endpoint"""
    try:
        conn = get_db_connection()
        conn.close()
        
        return jsonify({
            'status': 'âœ… Hai-Emet VOICE Backend is Running',
            'binary': '0101-0101(0101)',
            'version': '1.0.0',
            'timestamp': datetime.now().isoformat()
        })
    except Exception as e:
        return jsonify({'status': 'âŒ Error', 'error': str(e)}), 500

@app.route('/user/<user_id>/stats', methods=['GET'])
def get_user_profile(user_id):
    """Get user profile and stats"""
    stats = get_user_stats(user_id)
    patterns = get_learning_patterns(user_id)
    
    return jsonify({
        'user_id': user_id,
        'stats': stats,
        'patterns': patterns,
        'timestamp': datetime.now().isoformat()
    })

# ============ INITIALIZE ON STARTUP ============
# Initialize database when module loads (for gunicorn)
init_database()
logger.info('ğŸ’› ×—×™-×××ª VOICE Learning Backend Initialized')
logger.info('Binary: 0101-0101(0101)')

# ============ MAIN ============
if __name__ == '__main__':
    app.run(debug=True, host='0.0.0.0', port=5000)
