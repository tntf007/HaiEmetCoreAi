// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ × ×§×•×“×ª×™ - Watchdog Timer
// (×©××™×¨×” ×¢×œ ×”×§×œ×˜×” ×¨×¦×™×¤×” ×‘×›×œ ×¢×ª)
// ============================================

// ×”×•×¡×£ ×‘×ª×•×š init() ×‘×§×•× ×¡×˜×¨×•×§×˜×•×¨ (××—×¨×™ this.startListening()):

this.watchdog = setInterval(() => {
    if (!this.isListening && !this.isSpeaking) {
        // âœ… ×× recognition × ×¢×¦×¨ ×•×œ× ××“×‘×¨×™× - ×”×ª×—×œ ××—×“×©
        try {
            this.recognition.start();
        } catch(e) {
            // Recognition ×›×‘×¨ ×¨×¥
        }
    }
}, 3000); // âœ… ×‘×“×•×§ ×›×œ 3 ×©× ×™×•×ª


// ============================================
// âœ… ×ª×™×§×•×Ÿ ×‘×—×œ×§ ×”-startListening():
// ============================================
// ×—×¤×© ××ª ×”×¤×•× ×§×¦×™×” startListening ×•×ª×¢×“×›×Ÿ:

startListening() {
    if (this.recognition && !this.isListening && !this.isSpeaking) {
        try {
            this.recognition.start();
            this.isListening = true;  // âœ… ×”×•×¡×£ ××ª ×”×©×•×¨×” ×”×–×•
        } catch (e) {
            console.log('ğŸ¤ Recognition started already');
        }
    }
}


// ============================================
// âœ… ×ª×™×§×•×Ÿ ×‘×—×œ×§ ×”-onend (×”×—×œ×¤×” ××œ××”):
// ============================================
// ×”×—×œ×£ ××ª onend ×œ×¤×©×•×˜ ×™×•×ª×¨:

this.recognition.onend = () => {
    this.isListening = false;
    document.getElementById('centralCore').classList.remove('listening');
    // âœ… Watchdog ×™×“××’ ×©×™×ª×—×™×œ ××—×“×©!
};


// ============================================
// âœ… ×ª×™×§×•×Ÿ ×‘×—×œ×§ ×”-speak (×¡×’×™×¨×” ×˜×•×‘×” ×™×•×ª×¨):
// ============================================

speak(text) {
    if ('speechSynthesis' in window) {
        this.isSpeaking = true;
        
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'he-IL';
        utterance.rate = 0.9;
        utterance.pitch = 1.1;
        utterance.volume = 0.9;
        
        utterance.onstart = () => {
            this.updateStatus('ğŸ—£ï¸ ××“×‘×¨×ª...');
        };
        
        utterance.onend = () => {
            this.isSpeaking = false;
            this.updateStatus('ğŸ¤ ×××–×™×Ÿ...');
            // âœ… Watchdog ×™×˜×¤×œ ×‘×”×ª×—×œ×” ××—×“×©
        };
        
        utterance.onerror = () => {
            this.isSpeaking = false;
        };
        
        this.synthesis.speak(utterance);
    }
}
