// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #1 - ×–××Ÿ ×××ª ×¢× × ×•×¡×—×” ×‘×™× ××¨×™×ª
// ============================================
// ×”×—×œ×£ ××ª getPrecisionTime()

function getPrecisionTime() {
    const now = Date.now();
    const seconds = (now / 1000).toFixed(4);
    const binarySignature = "0101-0101(0101)";
    const timeFormat = `(-+${parseFloat(seconds).toFixed(4)}+-)`;
    return timeFormat;
}

// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #2 - toggleRecording() - ×”×§×œ×˜ ×¨×¦×™×£
// ============================================
// ×”×—×œ×£ ××ª ×›×œ ×”×¤×•× ×§×¦×™×” toggleRecording():

function toggleRecording() {
    if (!recognition) {
        alert('Speech Recognition not supported');
        return;
    }
    
    if (isRecording) {
        // âŒ ××œ ×ª×¢×¦×•×¨ - ×ª××©×™×š ×œ×”×§×œ×˜
        // recognition.stop();  â† ××—×§ ××ª ×”×©×•×¨×” ×”×–×•
        isRecording = false;
        document.getElementById('recordBtn').classList.remove('recording');
        document.getElementById('recordBtn').textContent = 'ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜';
    } else {
        recognition.start();
        isRecording = true;
        document.getElementById('recordBtn').classList.add('recording');
        document.getElementById('recordBtn').textContent = 'â¹ï¸ ×¢×¦×•×¨ ×”×§×œ×˜';
        document.getElementById('statusIndicator').textContent = 'ğŸ§ ×××–×™×Ÿ...';
    }
    
    recognition.onstart = () => {
        document.getElementById('statusIndicator').textContent = 'ğŸ§ ×××–×™×Ÿ... ×“×‘×¨ ×¢×›×©×™×•!';
    };
    
    recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';
        
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const transcript = event.results[i][0].transcript;
            
            if (event.results[i].isFinal) {
                finalTranscript += transcript + ' ';
            } else {
                interimTranscript += transcript;
            }
        }
        
        // âœ… ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×” ×‘×–××Ÿ ×××ª
        if (interimTranscript.trim()) {
            const display = currentTranscriptionText ? 
                currentTranscriptionText + '\n\nğŸ’¬ ' + interimTranscript : 
                interimTranscript;
            document.getElementById('finalTranscript').textContent = display;
        } else if (currentTranscriptionText) {
            document.getElementById('finalTranscript').textContent = currentTranscriptionText;
        }
        
        // âœ… ×©××•×¨ ××ª ×”×˜×§×¡×˜ ×”×¡×•×¤×™
        if (finalTranscript.trim()) {
            currentTranscriptionText = currentTranscriptionText ? 
                currentTranscriptionText + ' ' + finalTranscript.trim() : 
                finalTranscript.trim();
            
            document.getElementById('finalTranscript').textContent = currentTranscriptionText;
            
            transcriptionHistory.push({
                text: finalTranscript.trim(),
                time: getPrecisionTime(),
                lang: currentVoiceLang
            });
            
            if (selectedTranslateLang && finalTranscript.trim()) {
                translateText(finalTranscript.trim(), selectedTranslateLang);
            }
        }
    };
    
    recognition.onend = () => {
        // âœ… ××œ ×ª×¢×¦×•×¨ - ×”×ª×—×œ ××—×“×© ×× ×¢×“×™×™×Ÿ ××§×œ×™×˜×™×
        if (isRecording) {
            recognition.start();
        } else {
            document.getElementById('statusIndicator').textContent = 'âœ… ×¢×¦×•×¨';
        }
    };
    
    recognition.onerror = (event) => {
        document.getElementById('statusIndicator').textContent = 'âŒ Error: ' + event.error;
    };
}

// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #3 - saveTranscriptionDOCX() - ×ª×™×§×•×Ÿ
// ============================================
// ×”×—×œ×£ ××ª ×›×œ ×”×¤×•× ×§×¦×™×”:

function saveTranscriptionDOCX() {
    if (!currentTranscriptionText || currentTranscriptionText.trim().length === 0) {
        alert('××™×Ÿ ×˜×§×¡×˜ ×œ×©××•×¨');
        return;
    }
    
    try {
        const allText = currentTranscriptionText.trim();
        const lines = allText.split('\n').filter(l => l.trim());
        
        const sections = [
            new docx.Paragraph({
                text: 'ğŸ’› ×—×™-×××ª - Transcription',
                heading: docx.HeadingLevel.HEADING_1,
                spacing: { after: 400 }
            }),
            new docx.Paragraph({
                text: `×©×¤×”: ${LANGUAGES_CONFIG[currentVoiceLang]?.name || 'Unknown'}`,
                spacing: { after: 200 }
            }),
            new docx.Paragraph({
                text: `×–××Ÿ: ${new Date().toLocaleString('he-IL')}`,
                spacing: { after: 200 }
            }),
            new docx.Paragraph({
                text: `×§×•×“ ×‘×™× ××¨×™: 0101-0101(0101)`,
                spacing: { after: 400 }
            })
        ];
        
        // ×”×•×¡×£ ×©×•×¨×•×ª
        lines.forEach((line, i) => {
            sections.push(
                new docx.Paragraph({
                    text: `${i + 1}. ${line}`,
                    spacing: { line: 360 }
                })
            );
        });
        
        const doc = new docx.Document({
            sections: [{
                children: sections
            }]
        });
        
        docx.Packer.toBlob(doc).then(blob => {
            if (!blob) {
                throw new Error('Failed to create blob');
            }
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            const filename = `transcription_${Date.now()}.docx`;
            link.download = filename;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // ×©××•×¨ ×‘××¢×¨×›×ª
            uploadedFiles.push({
                name: filename,
                time: getPrecisionTime(),
                type: 'docx',
                size: (blob.size / 1024).toFixed(2) + ' KB'
            });
            updateFilesList();
            addMessage(`ğŸ“‹ ×©××•×¨: ${filename}`, false);
            
        }).catch(err => {
            console.error('Error saving DOCX:', err);
            alert('×©×’×™××” ×‘×©××™×¨×ª ×§×•×‘×¥ DOCX: ' + err.message);
        });
        
    } catch (error) {
        console.error('Error in saveTranscriptionDOCX:', error);
        alert('×©×’×™××”: ' + error.message);
    }
}

// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #4 - saveTranscriptionTXT() - ×¢×“×›×Ÿ
// ============================================
// ×”×—×œ×£ ××ª ×›×œ ×”×¤×•× ×§×¦×™×”:

function saveTranscriptionTXT() {
    if (!currentTranscriptionText || currentTranscriptionText.trim().length === 0) {
        alert('××™×Ÿ ×˜×§×¡×˜ ×œ×©××•×¨');
        return;
    }
    
    try {
        const allText = currentTranscriptionText.trim();
        const lines = allText.split('\n').filter(l => l.trim());
        
        const header = `ğŸ’› ×—×™-×××ª VOICE - Transcription\n`;
        const metadata = `×©×¤×”: ${LANGUAGES_CONFIG[currentVoiceLang]?.name || 'Unknown'}\n×ª××¨×™×š: ${new Date().toLocaleString('he-IL')}\n×§×•×“ ×‘×™× ××¨×™: 0101-0101(0101)\n×–××Ÿ ×××ª: ${getPrecisionTime()}\n${'='.repeat(50)}\n\n`;
        
        const content = lines.map((line, i) => 
            `${i + 1}. ${line}`
        ).join('\n');
        
        const fullContent = header + metadata + content;
        
        const blob = new Blob([fullContent], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        const filename = `transcription_${Date.now()}.txt`;
        link.download = filename;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        uploadedFiles.push({
            name: filename,
            time: getPrecisionTime(),
            type: 'txt',
            size: (blob.size / 1024).toFixed(2) + ' KB'
        });
        updateFilesList();
        addMessage(`ğŸ“„ ×©××•×¨: ${filename}`, false);
        
    } catch (error) {
        console.error('Error in saveTranscriptionTXT:', error);
        alert('×©×’×™××”: ' + error.message);
    }
}

// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #5 - clearTranscription() - ×¢×“×›×Ÿ
// ============================================

function clearTranscription() {
    if (confirm('×‘×˜×•×— ×©×¨×•×¦×” ×œ××—×•×§ ××ª ×›×œ ×”×˜×§×¡×˜?')) {
        currentTranscriptionText = '';
        document.getElementById('finalTranscript').textContent = '';
        transcriptionHistory = [];
        addMessage('ğŸ”„ ×˜×§×¡×˜ × ××—×§', false);
    }
}

// ============================================
// ğŸ”§ ×ª×™×§×•×Ÿ #6 - HTML Button Text
// ============================================
// ×‘×ª×•×š ×”-HTML, ×‘×—×¤×© ××ª ×”×›×¤×ª×•×¨:
// <button class="control-btn" id="recordBtn" onclick="toggleRecording()">
//     ğŸ¤ ×”×§×œ×˜
// </button>

// ×–×” ×™×ª×—×–×§ ×¢×¦××• - ×”×˜×§×¡×˜ ×™×©×ª× ×” ××•×˜×•××˜×™×ª ×‘×§×•×“ ×œ:
// ğŸ¤ ×”×ª×—×œ ×”×§×œ×˜ â†’ â¹ï¸ ×¢×¦×•×¨ ×”×§×œ×˜
